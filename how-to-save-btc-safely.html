

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>How to save btc safely. &#8212; My book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'how-to-save-btc-safely';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="How to use electrum?" href="how-to-use-electrum.html" />
    <link rel="prev" title="Welcome to your Jupyter Book" href="intro.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="My book - Home"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="My book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Welcome to your Jupyter Book
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">How to save btc safely.</a></li>
<li class="toctree-l1"><a class="reference internal" href="how-to-use-electrum.html">How to use electrum?</a></li>
<li class="toctree-l1"><a class="reference internal" href="ordinals.html">Ordinals</a></li>
<li class="toctree-l1"><a class="reference internal" href="how-eth-pos-works.html">POS</a></li>
<li class="toctree-l1"><a class="reference internal" href="NTT.html">NTT revised</a></li>
<li class="toctree-l1"><a class="reference internal" href="a-math-prob.html">a math problem</a></li>



<li class="toctree-l1"><a class="reference internal" href="op_cat.html">op-cat</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/daizisheng/book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/daizisheng/book/issues/new?title=Issue%20on%20page%20%2Fhow-to-save-btc-safely.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/how-to-save-btc-safely.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>How to save btc safely.</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bip0039">BIP0039 生成确定性密钥的助记词</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bip0032">BIP0032 分层确定性钱包</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bither-net">bither.net钱包</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bitherhd">bither非HD模式</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ledger-nano-s-plus">Ledger Nano S Plus</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#btc">手搓BTC</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#multi-sigbtc">multi-sig多签存储btc</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#electrum">Electrum钱包</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="how-to-save-btc-safely">
<h1>How to save btc safely.<a class="headerlink" href="#how-to-save-btc-safely" title="Permalink to this heading">#</a></h1>
<section id="bip0039">
<h2>BIP0039 生成确定性密钥的助记词<a class="headerlink" href="#bip0039" title="Permalink to this heading">#</a></h2>
<p><a class="reference external" href="https://en.bitcoin.it/wiki/BIP_0039">https://en.bitcoin.it/wiki/BIP_0039</a></p>
<p><strong>BTC私钥</strong> 实际上就是一个32字节的随机数组，而 <strong>公钥</strong> 是通过将椭圆曲线的 <strong>生成元点</strong> 自加而得到，自加的次数就是这个私钥 ，此时私钥被当作一个大整数。而 <strong>BTC地址</strong> 则是通过把公钥哈希而得到。程序逻辑如下：</p>
<p>例子来自 <a class="reference external" href="https://en.bitcoin.it/wiki/Technical_background_of_version_1_Bitcoin_addresses">https://en.bitcoin.it/wiki/Technical_background_of_version_1_Bitcoin_addresses</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># 设置随机数种子，以便结果可重复</span>
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># 随机生成一个私钥</span>
<span class="n">private_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">256</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># 为了方便，我们直接使用一个固定的私钥</span>
<span class="n">private_key</span> <span class="o">=</span> <span class="mh">0x18e14a7b6a307f426a94f8114701e7c8e774e7f9a47e2c2035db29a206321725</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;private_key: 0x</span><span class="si">{</span><span class="n">private_key</span><span class="si">:</span><span class="s2">064x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>private_key: 0x18e14a7b6a307f426a94f8114701e7c8e774e7f9a47e2c2035db29a206321725
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># BTC所选择的椭圆曲线是secp256k1, 其参数如下</span>
<span class="n">secp256k1_p</span> <span class="o">=</span> <span class="mh">0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFC2F</span>
<span class="n">secp256k1_a</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">secp256k1_b</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">secp256k1_n</span> <span class="o">=</span> <span class="mh">0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEBAAEDCE6AF48A03BBFD25E8CD0364141</span>
<span class="n">secp256k1_Gx</span> <span class="o">=</span> <span class="mh">0x79BE667EF9DCBBAC55A06295CE870B07029BFCDB2DCE28D959F2815B16F81798</span>
<span class="n">secp256k1_Gy</span> <span class="o">=</span> <span class="mh">0x483ADA7726A3C4655DA4FBFC0E1108A8FD17B448A68554199C47D08FFB10D4B8</span>

<span class="c1"># 椭圆曲线的方程是 y^2 = x^3 + ax + b</span>

<span class="c1"># 椭圆曲线上的加法如下，其中 None 表示无穷远点，即加法的单位元，即 0，p1和p2是椭圆曲线上的点</span>
<span class="k">def</span> <span class="nf">secp256k1_add</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">p1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">p2</span>
    <span class="k">if</span> <span class="n">p2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">p1</span>
    <span class="k">if</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="c1"># 两个点互为相反数，即相加为0</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="n">secp256k1_p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="c1"># s是斜率</span>
    <span class="k">if</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">secp256k1_a</span><span class="p">)</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">secp256k1_p</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">secp256k1_p</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="n">s</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">%</span> <span class="n">secp256k1_p</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span> <span class="o">-</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">)</span> <span class="o">%</span> <span class="n">secp256k1_p</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="c1"># 私钥 -&gt; 公钥 (倍点算法)</span>
<span class="k">def</span> <span class="nf">priv_key_to_pub_key</span><span class="p">(</span><span class="n">priv_key</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">priv_key</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">256</span>
    <span class="c1"># 生成公钥</span>
    <span class="n">pub_key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="n">secp256k1_Gx</span><span class="p">,</span> <span class="n">secp256k1_Gy</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">priv_key</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">):</span>
            <span class="n">pub_key</span> <span class="o">=</span> <span class="n">secp256k1_add</span><span class="p">(</span><span class="n">pub_key</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">secp256k1_add</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pub_key</span>

<span class="c1"># 生成公钥</span>
<span class="n">pub_key</span> <span class="o">=</span> <span class="n">priv_key_to_pub_key</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pub_key: 0x</span><span class="si">{</span><span class="n">pub_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">064x</span><span class="si">}</span><span class="s2">, 0x</span><span class="si">{</span><span class="n">pub_key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">064x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># 压缩形式的公钥</span>
<span class="k">if</span> <span class="n">pub_key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">compressed_pub_key</span> <span class="o">=</span> <span class="mh">0x03</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">compressed_pub_key</span> <span class="o">=</span> <span class="mh">0x02</span>
<span class="n">compressed_pub_key</span> <span class="o">=</span> <span class="n">compressed_pub_key</span> <span class="o">&lt;&lt;</span> <span class="mi">256</span> <span class="o">|</span> <span class="n">pub_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;compressed_pub_key: 0x</span><span class="si">{</span><span class="n">compressed_pub_key</span><span class="si">:</span><span class="s2">066x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>pub_key: 0x50863ad64a87ae8a2fe83c1af1a8403cb53f53e486d8511dad8a04887e5b2352, 0x2cd470243453a299fa9e77237716103abc11a1df38855ed6f2ee187e9c582ba6
compressed_pub_key: 0x0250863ad64a87ae8a2fe83c1af1a8403cb53f53e486d8511dad8a04887e5b2352
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">hashlib</span>

<span class="c1"># 生成地址</span>
<span class="n">hashed_pub_key</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">compressed_pub_key</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">33</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sha256ed_pub_key: 0x</span><span class="si">{</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">hashed_pub_key</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;big&#39;</span><span class="p">)</span><span class="si">:</span><span class="s2">064x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">ripemd160_hasher</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;ripemd160&#39;</span><span class="p">)</span>
<span class="n">ripemd160_hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hashed_pub_key</span><span class="p">)</span>
<span class="n">ripemd160_pub_key</span> <span class="o">=</span> <span class="n">ripemd160_hasher</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ripemd160ed_pub_key: 0x</span><span class="si">{</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">ripemd160_pub_key</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;big&#39;</span><span class="p">)</span><span class="si">:</span><span class="s2">040x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">ripemd160_pub_key_with_version</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">ripemd160_pub_key</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span> <span class="c1"># 添加版本号</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ripemd160_pub_key_with_version: 0x</span><span class="si">{</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">ripemd160_pub_key_with_version</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;big&#39;</span><span class="p">)</span><span class="si">:</span><span class="s2">042x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">hashed_ripemd160_pub_key_with_version</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">ripemd160_pub_key_with_version</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sha256ed_ripemd160_pub_key_with_version: 0x</span><span class="si">{</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">hashed_ripemd160_pub_key_with_version</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;big&#39;</span><span class="p">)</span><span class="si">:</span><span class="s2">064x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">hashed_twice_ripemd160_pub_key_with_version</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">hashed_ripemd160_pub_key_with_version</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sha256ed_twice_ripemd160_pub_key_with_version: 0x</span><span class="si">{</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">hashed_twice_ripemd160_pub_key_with_version</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;big&#39;</span><span class="p">)</span><span class="si">:</span><span class="s2">064x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">checksum</span> <span class="o">=</span> <span class="n">hashed_twice_ripemd160_pub_key_with_version</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;checksum: 0x</span><span class="si">{</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">checksum</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;big&#39;</span><span class="p">)</span><span class="si">:</span><span class="s2">08x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">address</span> <span class="o">=</span> <span class="n">ripemd160_pub_key_with_version</span> <span class="o">+</span> <span class="n">checksum</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;address: 0x</span><span class="si">{</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;big&#39;</span><span class="p">)</span><span class="si">:</span><span class="s2">050x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># base58编码</span>
<span class="kn">import</span> <span class="nn">base58</span>
<span class="n">address</span> <span class="o">=</span> <span class="n">base58</span><span class="o">.</span><span class="n">b58encode</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;base58 address: </span><span class="si">{</span><span class="n">address</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">address</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;1PMycacnJaSqwwJqjawXBErnLsZ7RkXUAs&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sha256ed_pub_key: 0x0b7c28c9b7290c98d7438e70b3d3f7c848fbd7d1dc194ff83f4f7cc9b1378e98
ripemd160ed_pub_key: 0xf54a5851e9372b87810a8e60cdd2e7cfd80b6e31
ripemd160_pub_key_with_version: 0x00f54a5851e9372b87810a8e60cdd2e7cfd80b6e31
sha256ed_ripemd160_pub_key_with_version: 0xad3c854da227c7e99c4abfad4ea41d71311160df2e415e713318c70d67c6b41c
sha256ed_twice_ripemd160_pub_key_with_version: 0xc7f18fe8fcbed6396741e58ad259b5cb16b7fd7f041904147ba1dcffabf747fd
checksum: 0xc7f18fe8
address: 0x00f54a5851e9372b87810a8e60cdd2e7cfd80b6e31c7f18fe8
base58 address: 1PMycacnJaSqwwJqjawXBErnLsZ7RkXUAs
</pre></div>
</div>
</div>
</div>
<p>上面就是生成私钥，以及从私钥生成比特币地址的完整过程。为了防止币的丢失，就必须保证私钥被妥善保管。私钥的随机性，导致了私钥难于准确的被记录。BIP0039尝试解决这个问题。</p>
<p>BIP0039中，我们首先生成 <strong>随机比特</strong> ，然后根据随机比特生成 <strong>助记词</strong> ，然后根据助记词生成 <strong>私钥</strong>。我们只需要记住助记词，就能随时重新生成私钥，从而生成公钥以及地址。而助记词由若干单词组成，方便记忆或者记录。为了进一步方便记忆和记录，BIP0039对助记词的选择做了限制，并且还添加了额外的冗余防止记忆出错。</p>
<p>助记词词典由2048个英文单词组成。这个词典还有一些特殊性质，一切都是为了更容易记忆或者记录。</p>
<ol class="arabic simple">
<li><p>只要前4个字母，就能区分所有单词。</p></li>
<li><p>相似的词语不选用。</p></li>
<li><p>单词列表是有序的。</p></li>
</ol>
<p>完整的单词列表如下：</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mnemonic_word_list</span> <span class="o">=</span> <span class="s1">&#39;abandon ability able about above absent absorb abstract absurd abuse access accident account accuse achieve acid acoustic acquire across act action actor actress actual adapt add addict address adjust admit adult advance advice aerobic affair afford afraid again age agent agree ahead aim air airport aisle alarm album alcohol alert alien all alley allow almost alone alpha already also alter always amateur amazing among amount amused analyst anchor ancient anger angle angry animal ankle announce annual another answer antenna antique anxiety any apart apology appear apple approve april arch arctic area arena argue arm armed armor army around arrange arrest arrive arrow art artefact artist artwork ask aspect assault asset assist assume asthma athlete atom attack attend attitude attract auction audit august aunt author auto autumn average avocado avoid awake aware away awesome awful awkward axis baby bachelor bacon badge bag balance balcony ball bamboo banana banner bar barely bargain barrel base basic basket battle beach bean beauty because become beef before begin behave behind believe below belt bench benefit best betray better between beyond bicycle bid bike bind biology bird birth bitter black blade blame blanket blast bleak bless blind blood blossom blouse blue blur blush board boat body boil bomb bone bonus book boost border boring borrow boss bottom bounce box boy bracket brain brand brass brave bread breeze brick bridge brief bright bring brisk broccoli broken bronze broom brother brown brush bubble buddy budget buffalo build bulb bulk bullet bundle bunker burden burger burst bus business busy butter buyer buzz cabbage cabin cable cactus cage cake call calm camera camp can canal cancel candy cannon canoe canvas canyon capable capital captain car carbon card cargo carpet carry cart case cash casino castle casual cat catalog catch category cattle caught cause caution cave ceiling celery cement census century cereal certain chair chalk champion change chaos chapter charge chase chat cheap check cheese chef cherry chest chicken chief child chimney choice choose chronic chuckle chunk churn cigar cinnamon circle citizen city civil claim clap clarify claw clay clean clerk clever click client cliff climb clinic clip clock clog close cloth cloud clown club clump cluster clutch coach coast coconut code coffee coil coin collect color column combine come comfort comic common company concert conduct confirm congress connect consider control convince cook cool copper copy coral core corn correct cost cotton couch country couple course cousin cover coyote crack cradle craft cram crane crash crater crawl crazy cream credit creek crew cricket crime crisp critic crop cross crouch crowd crucial cruel cruise crumble crunch crush cry crystal cube culture cup cupboard curious current curtain curve cushion custom cute cycle dad damage damp dance danger daring dash daughter dawn day deal debate debris decade december decide decline decorate decrease deer defense define defy degree delay deliver demand demise denial dentist deny depart depend deposit depth deputy derive describe desert design desk despair destroy detail detect develop device devote diagram dial diamond diary dice diesel diet differ digital dignity dilemma dinner dinosaur direct dirt disagree discover disease dish dismiss disorder display distance divert divide divorce dizzy doctor document dog doll dolphin domain donate donkey donor door dose double dove draft dragon drama drastic draw dream dress drift drill drink drip drive drop drum dry duck dumb dune during dust dutch duty dwarf dynamic eager eagle early earn earth easily east easy echo ecology economy edge edit educate effort egg eight either elbow elder electric elegant element elephant elevator elite else embark embody embrace emerge emotion employ empower empty enable enact end endless endorse enemy energy enforce engage engine enhance enjoy enlist enough enrich enroll ensure enter entire entry envelope episode equal equip era erase erode erosion error erupt escape essay essence estate eternal ethics evidence evil evoke evolve exact example excess exchange excite exclude excuse execute exercise exhaust exhibit exile exist exit exotic expand expect expire explain expose express extend extra eye eyebrow fabric face faculty fade faint faith fall false fame family famous fan fancy fantasy farm fashion fat fatal father fatigue fault favorite feature february federal fee feed feel female fence festival fetch fever few fiber fiction field figure file film filter final find fine finger finish fire firm first fiscal fish fit fitness fix flag flame flash flat flavor flee flight flip float flock floor flower fluid flush fly foam focus fog foil fold follow food foot force forest forget fork fortune forum forward fossil foster found fox fragile frame frequent fresh friend fringe frog front frost frown frozen fruit fuel fun funny furnace fury future gadget gain galaxy gallery game gap garage garbage garden garlic garment gas gasp gate gather gauge gaze general genius genre gentle genuine gesture ghost giant gift giggle ginger giraffe girl give glad glance glare glass glide glimpse globe gloom glory glove glow glue goat goddess gold good goose gorilla gospel gossip govern gown grab grace grain grant grape grass gravity great green grid grief grit grocery group grow grunt guard guess guide guilt guitar gun gym habit hair half hammer hamster hand happy harbor hard harsh harvest hat have hawk hazard head health heart heavy hedgehog height hello helmet help hen hero hidden high hill hint hip hire history hobby hockey hold hole holiday hollow home honey hood hope horn horror horse hospital host hotel hour hover hub huge human humble humor hundred hungry hunt hurdle hurry hurt husband hybrid ice icon idea identify idle ignore ill illegal illness image imitate immense immune impact impose improve impulse inch include income increase index indicate indoor industry infant inflict inform inhale inherit initial inject injury inmate inner innocent input inquiry insane insect inside inspire install intact interest into invest invite involve iron island isolate issue item ivory jacket jaguar jar jazz jealous jeans jelly jewel job join joke journey joy judge juice jump jungle junior junk just kangaroo keen keep ketchup key kick kid kidney kind kingdom kiss kit kitchen kite kitten kiwi knee knife knock know lab label labor ladder lady lake lamp language laptop large later latin laugh laundry lava law lawn lawsuit layer lazy leader leaf learn leave lecture left leg legal legend leisure lemon lend length lens leopard lesson letter level liar liberty library license life lift light like limb limit link lion liquid list little live lizard load loan lobster local lock logic lonely long loop lottery loud lounge love loyal lucky luggage lumber lunar lunch luxury lyrics machine mad magic magnet maid mail main major make mammal man manage mandate mango mansion manual maple marble march margin marine market marriage mask mass master match material math matrix matter maximum maze meadow mean measure meat mechanic medal media melody melt member memory mention menu mercy merge merit merry mesh message metal method middle midnight milk million mimic mind minimum minor minute miracle mirror misery miss mistake mix mixed mixture mobile model modify mom moment monitor monkey monster month moon moral more morning mosquito mother motion motor mountain mouse move movie much muffin mule multiply muscle museum mushroom music must mutual myself mystery myth naive name napkin narrow nasty nation nature near neck need negative neglect neither nephew nerve nest net network neutral never news next nice night noble noise nominee noodle normal north nose notable note nothing notice novel now nuclear number nurse nut oak obey object oblige obscure observe obtain obvious occur ocean october odor off offer office often oil okay old olive olympic omit once one onion online only open opera opinion oppose option orange orbit orchard order ordinary organ orient original orphan ostrich other outdoor outer output outside oval oven over own owner oxygen oyster ozone pact paddle page pair palace palm panda panel panic panther paper parade parent park parrot party pass patch path patient patrol pattern pause pave payment peace peanut pear peasant pelican pen penalty pencil people pepper perfect permit person pet phone photo phrase physical piano picnic picture piece pig pigeon pill pilot pink pioneer pipe pistol pitch pizza place planet plastic plate play please pledge pluck plug plunge poem poet point polar pole police pond pony pool popular portion position possible post potato pottery poverty powder power practice praise predict prefer prepare present pretty prevent price pride primary print priority prison private prize problem process produce profit program project promote proof property prosper protect proud provide public pudding pull pulp pulse pumpkin punch pupil puppy purchase purity purpose purse push put puzzle pyramid quality quantum quarter question quick quit quiz quote rabbit raccoon race rack radar radio rail rain raise rally ramp ranch random range rapid rare rate rather raven raw razor ready real reason rebel rebuild recall receive recipe record recycle reduce reflect reform refuse region regret regular reject relax release relief rely remain remember remind remove render renew rent reopen repair repeat replace report require rescue resemble resist resource response result retire retreat return reunion reveal review reward rhythm rib ribbon rice rich ride ridge rifle right rigid ring riot ripple risk ritual rival river road roast robot robust rocket romance roof rookie room rose rotate rough round route royal rubber rude rug rule run runway rural sad saddle sadness safe sail salad salmon salon salt salute same sample sand satisfy satoshi sauce sausage save say scale scan scare scatter scene scheme school science scissors scorpion scout scrap screen script scrub sea search season seat second secret section security seed seek segment select sell seminar senior sense sentence series service session settle setup seven shadow shaft shallow share shed shell sheriff shield shift shine ship shiver shock shoe shoot shop short shoulder shove shrimp shrug shuffle shy sibling sick side siege sight sign silent silk silly silver similar simple since sing siren sister situate six size skate sketch ski skill skin skirt skull slab slam sleep slender slice slide slight slim slogan slot slow slush small smart smile smoke smooth snack snake snap sniff snow soap soccer social sock soda soft solar soldier solid solution solve someone song soon sorry sort soul sound soup source south space spare spatial spawn speak special speed spell spend sphere spice spider spike spin spirit split spoil sponsor spoon sport spot spray spread spring spy square squeeze squirrel stable stadium staff stage stairs stamp stand start state stay steak steel stem step stereo stick still sting stock stomach stone stool story stove strategy street strike strong struggle student stuff stumble style subject submit subway success such sudden suffer sugar suggest suit summer sun sunny sunset super supply supreme sure surface surge surprise surround survey suspect sustain swallow swamp swap swarm swear sweet swift swim swing switch sword symbol symptom syrup system table tackle tag tail talent talk tank tape target task taste tattoo taxi teach team tell ten tenant tennis tent term test text thank that theme then theory there they thing this thought three thrive throw thumb thunder ticket tide tiger tilt timber time tiny tip tired tissue title toast tobacco today toddler toe together toilet token tomato tomorrow tone tongue tonight tool tooth top topic topple torch tornado tortoise toss total tourist toward tower town toy track trade traffic tragic train transfer trap trash travel tray treat tree trend trial tribe trick trigger trim trip trophy trouble truck true truly trumpet trust truth try tube tuition tumble tuna tunnel turkey turn turtle twelve twenty twice twin twist two type typical ugly umbrella unable unaware uncle uncover under undo unfair unfold unhappy uniform unique unit universe unknown unlock until unusual unveil update upgrade uphold upon upper upset urban urge usage use used useful useless usual utility vacant vacuum vague valid valley valve van vanish vapor various vast vault vehicle velvet vendor venture venue verb verify version very vessel veteran viable vibrant vicious victory video view village vintage violin virtual virus visa visit visual vital vivid vocal voice void volcano volume vote voyage wage wagon wait walk wall walnut want warfare warm warrior wash wasp waste water wave way wealth weapon wear weasel weather web wedding weekend weird welcome west wet whale what wheat wheel when where whip whisper wide width wife wild will win window wine wing wink winner winter wire wisdom wise wish witness wolf woman wonder wood wool word work world worry worth wrap wreck wrestle wrist write wrong yard year yellow you young youth zebra zero zone zoo&#39;</span>
<span class="n">mnemonic_word_list</span> <span class="o">=</span> <span class="n">mnemonic_word_list</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">mnemonic_word_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2048</span>

<span class="c1"># 检查前4位是否能唯一确定一个助记词</span>
<span class="k">def</span> <span class="nf">check_mnemonic_word_list</span><span class="p">(</span><span class="n">mnemonic_word_list</span><span class="p">):</span>
    <span class="n">mnemonic_word_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mnemonic_word_list</span><span class="p">)</span>
    <span class="n">mnemonic_word_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">word</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">mnemonic_word_list</span><span class="p">]</span>
    <span class="n">mnemonic_word_list</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">mnemonic_word_list</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">mnemonic_word_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2048</span>
<span class="n">check_mnemonic_word_list</span><span class="p">(</span><span class="n">mnemonic_word_list</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mnemonic_word_list: </span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mnemonic_word_list</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span><span class="si">}</span><span class="s2">,...&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mnemonic_word_list: abandon,ability,able,about,...
</pre></div>
</div>
</div>
</div>
<p>助记词的个数可以是12个或者更多，我们以12个助记词为例来说明BIP0039。</p>
<p>12个助记词，每个助记词从2048个单词中随机挑选，说明我们至少需要 <code class="docutils literal notranslate"><span class="pre">12</span> <span class="pre">*</span> <span class="pre">11</span> <span class="pre">=</span> <span class="pre">132</span></code> 个随机比特。在BIP0039中，12个助记词我们使用4个比特的校验码，因此剩余的128个比特来自随机。示例如下：</p>
<p>测试例子来自 <a class="github reference external" href="https://github.com/trezor/python-mnemonic/blob/master/vectors.json">trezor/python-mnemonic</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">random_bits</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">128</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># 为了方便，我们直接使用一个固定的随机数</span>
<span class="n">random_bits</span> <span class="o">=</span> <span class="mh">0x9e885d952ad362caeb4efe34a8e91bd2</span>

<span class="n">random_bytes</span> <span class="o">=</span> <span class="n">random_bits</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
<span class="n">sha256ed_random_bytes</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">random_bytes</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
<span class="n">sha256ed_random_bytes_as_int</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">sha256ed_random_bytes</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
<span class="n">random_bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">random_bits</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">sha256ed_random_bytes_as_int</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">256</span> <span class="o">-</span> <span class="mi">4</span><span class="p">))</span>

<span class="n">mnemonic</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
    <span class="n">mnemonic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mnemonic_word_list</span><span class="p">[</span><span class="n">random_bits</span> <span class="o">&amp;</span> <span class="mi">2047</span><span class="p">])</span>
    <span class="n">random_bits</span> <span class="o">=</span> <span class="n">random_bits</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span>
<span class="n">mnemonic</span> <span class="o">=</span> <span class="n">mnemonic</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">mnemonic</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mnemonic</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mnemonic: </span><span class="si">{</span><span class="n">mnemonic</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mnemonic: ozone drill grab fiber curtain grace pudding thank cruise elder eight picnic
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 这里选择TREZOR作为密码，是因为我们的测试例子来自TREZOR</span>
<span class="n">salt</span> <span class="o">=</span> <span class="s2">&quot;mnemonic&quot;</span> <span class="o">+</span> <span class="s2">&quot;TREZOR&quot;</span>

<span class="c1"># password based key derivation function 2</span>
<span class="n">seed</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">pbkdf2_hmac</span><span class="p">(</span><span class="s1">&#39;sha512&#39;</span><span class="p">,</span> <span class="n">mnemonic</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">salt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="mi">2048</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;seed: 0x</span><span class="si">{</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;big&#39;</span><span class="p">)</span><span class="si">:</span><span class="s2">0128x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">my_hmac</span><span class="p">(</span><span class="n">key_bytes</span><span class="p">,</span> <span class="n">msg_bytes</span><span class="p">):</span>
    <span class="n">block_size_of_sha512</span> <span class="o">=</span> <span class="mi">128</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_bytes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">block_size_of_sha512</span><span class="p">:</span>
        <span class="n">key_bytes</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha512</span><span class="p">(</span><span class="n">key_bytes</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span> <span class="o">+</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">block_size_of_sha512</span> <span class="o">-</span> <span class="mi">64</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">key_bytes</span> <span class="o">=</span> <span class="n">key_bytes</span> <span class="o">+</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">block_size_of_sha512</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_bytes</span><span class="p">))</span>
    <span class="n">opad</span> <span class="o">=</span> <span class="mh">0x5c</span>
    <span class="n">ipad</span> <span class="o">=</span> <span class="mh">0x36</span>

    <span class="n">part1</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">x</span> <span class="o">^</span> <span class="n">opad</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">key_bytes</span><span class="p">])</span>
    <span class="n">part2</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">x</span> <span class="o">^</span> <span class="n">ipad</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">key_bytes</span><span class="p">])</span> <span class="o">+</span> <span class="n">msg_bytes</span>
    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha512</span><span class="p">(</span><span class="n">part1</span> <span class="o">+</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha512</span><span class="p">(</span><span class="n">part2</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">())</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>

<span class="k">assert</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">my_hmac</span><span class="p">(</span> <span class="s2">&quot;key&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;The quick brown fox jumps over the lazy dog&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="p">),</span> <span class="s2">&quot;big&quot;</span><span class="p">)</span> <span class="o">==</span> \
        <span class="mh">0xb42af09057bac1e2d41708e48a902e09b5ff7f12ab428a4fe86653c73dd248fb82f948a549f7b791a5b41915ee4d1ec3935357e4e2317250d0372afa2ebeeb3a</span>

<span class="k">def</span> <span class="nf">my_pbkdf2</span><span class="p">(</span><span class="n">mnemonic_bytes</span><span class="p">,</span> <span class="n">salt_bytes</span><span class="p">):</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">salt_bytes</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2048</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">my_hmac</span><span class="p">(</span><span class="n">mnemonic_bytes</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">u</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">x</span> <span class="o">^</span> <span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">u</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">ret</span>

<span class="n">seed2</span> <span class="o">=</span> <span class="n">my_pbkdf2</span><span class="p">(</span><span class="n">mnemonic</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">salt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
<span class="k">assert</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">seed2</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>seed: 0x274ddc525802f7c828d8ef7ddbcdc5304e87ac3535913611fbbfa986d0c9e5476c91689f9c8a54fd55bd38606aa6a8595ad213d4c9c9f9aca3fb217069a41028
</pre></div>
</div>
</div>
</div>
<p>好了，有了这个seed之后怎么办？这个还需要 BIP0032 来帮助了。</p>
</section>
<section id="bip0032">
<h2>BIP0032 分层确定性钱包<a class="headerlink" href="#bip0032" title="Permalink to this heading">#</a></h2>
<p>如上，我们有了一个seed，原则上，我们把这个seed直接处理一下，就可以得到一个私钥，但是 BIP0032 给出了一个更好的方案，如何由一个seed确定性的得到很多的私钥。BIP0032其实解决了一个问题，那就是你可以只备份一次，就可以生成无限多个地址来使用。要知道，在早期，因为忘了及时备份，丢失新生成的地址上的币是很频繁的。历史上，比特币官方客户端在打币的时候，每次都会为找零生成新地址，这就更加剧了丢币的行为。</p>
<p>首先我们根据seed生成一个主私钥以及主公钥</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 为了方便，我们直接使用一个固定的seed</span>
<span class="n">seed</span> <span class="o">=</span> <span class="mh">0xfffcf9f6f3f0edeae7e4e1dedbd8d5d2cfccc9c6c3c0bdbab7b4b1aeaba8a5a29f9c999693908d8a8784817e7b7875726f6c696663605d5a5754514e4b484542</span>

<span class="n">I</span> <span class="o">=</span> <span class="n">my_hmac</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;Bitcoin seed&quot;</span><span class="p">,</span> <span class="n">seed</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">))</span>
<span class="n">I_L</span> <span class="o">=</span> <span class="n">I</span><span class="p">[:</span><span class="mi">32</span><span class="p">]</span>
<span class="n">I_R</span> <span class="o">=</span> <span class="n">I</span><span class="p">[</span><span class="mi">32</span><span class="p">:]</span>
<span class="n">master_private_key</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">I_L</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
<span class="n">master_chain_code</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">I_R</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
<span class="n">master_public_point</span> <span class="o">=</span> <span class="n">priv_key_to_pub_key</span><span class="p">(</span><span class="n">master_private_key</span><span class="p">)</span>
<span class="n">master_public_key</span> <span class="o">=</span> <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x02</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">master_public_point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x03</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">master_public_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;ripemd160&#39;</span><span class="p">)</span>
<span class="n">tmp</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">master_public_key</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">())</span>
<span class="n">hash160_master_public_key</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
<span class="n">master_fingerprint</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">hash160_master_public_key</span><span class="p">[:</span><span class="mi">4</span><span class="p">],</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">serialize_mainnet_private_key</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">chain_code</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">parent_fingerprint</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">child_number</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x0488ADE4</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span> <span class="c1"># version</span>
    <span class="n">ret</span> <span class="o">+=</span> <span class="n">depth</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span> <span class="c1"># depth</span>
    <span class="n">ret</span> <span class="o">+=</span> <span class="n">parent_fingerprint</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span> <span class="c1"># parent fingerprint</span>
    <span class="n">ret</span> <span class="o">+=</span> <span class="n">child_number</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span> <span class="c1"># child number</span>
    <span class="n">ret</span> <span class="o">+=</span> <span class="n">chain_code</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span> <span class="c1"># chain code</span>
    <span class="n">ret</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">private_key</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span> <span class="c1"># private key</span>
    <span class="n">checksum</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
    <span class="n">checksum</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">checksum</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
    <span class="n">ret</span> <span class="o">+=</span> <span class="n">checksum</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="c1"># checksum</span>
    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">serialize_mainnet_public_point</span><span class="p">(</span><span class="n">public_point</span><span class="p">,</span> <span class="n">chain_code</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">parent_fingerprint</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">child_number</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x0488B21E</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span> <span class="c1"># version</span>
    <span class="n">ret</span> <span class="o">+=</span> <span class="n">depth</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span> <span class="c1"># depth</span>
    <span class="n">ret</span> <span class="o">+=</span> <span class="n">parent_fingerprint</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span> <span class="c1"># parent fingerprint</span>
    <span class="n">ret</span> <span class="o">+=</span> <span class="n">child_number</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span> <span class="c1"># child number</span>
    <span class="n">ret</span> <span class="o">+=</span> <span class="n">chain_code</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span> <span class="c1"># chain code</span>
    <span class="k">if</span> <span class="n">public_point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x03</span><span class="s1">&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x02</span><span class="s1">&#39;</span>
    <span class="n">ret</span> <span class="o">+=</span> <span class="n">public_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span> <span class="c1"># public key</span>
    <span class="n">checksum</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
    <span class="n">checksum</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">checksum</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
    <span class="n">ret</span> <span class="o">+=</span> <span class="n">checksum</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="c1"># checksum</span>
    <span class="k">return</span> <span class="n">ret</span>

<span class="n">serialized_mainnet_private_key</span> <span class="o">=</span> <span class="n">base58</span><span class="o">.</span><span class="n">b58encode</span><span class="p">(</span><span class="n">serialize_mainnet_private_key</span><span class="p">(</span><span class="n">master_private_key</span><span class="p">,</span> <span class="n">master_chain_code</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;master_private_key: </span><span class="si">{</span><span class="n">serialized_mainnet_private_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">serialized_mainnet_private_key</span> <span class="o">==</span> <span class="s2">&quot;xprv9s21ZrQH143K31xYSDQpPDxsXRTUcvj2iNHm5NUtrGiGG5e2DtALGdso3pGz6ssrdK4PFmM8NSpSBHNqPqm55Qn3LqFtT2emdEXVYsCzC2U&quot;</span>

<span class="n">serialized_mainnet_public_point</span> <span class="o">=</span> <span class="n">base58</span><span class="o">.</span><span class="n">b58encode</span><span class="p">(</span><span class="n">serialize_mainnet_public_point</span><span class="p">(</span><span class="n">master_public_point</span><span class="p">,</span> <span class="n">master_chain_code</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;master_public_point: </span><span class="si">{</span><span class="n">serialized_mainnet_public_point</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">serialized_mainnet_public_point</span> <span class="o">==</span> <span class="s2">&quot;xpub661MyMwAqRbcFW31YEwpkMuc5THy2PSt5bDMsktWQcFF8syAmRUapSCGu8ED9W6oDMSgv6Zz8idoc4a6mr8BDzTJY47LJhkJ8UB7WEGuduB&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>master_private_key: xprv9s21ZrQH143K31xYSDQpPDxsXRTUcvj2iNHm5NUtrGiGG5e2DtALGdso3pGz6ssrdK4PFmM8NSpSBHNqPqm55Qn3LqFtT2emdEXVYsCzC2U
master_public_point: xpub661MyMwAqRbcFW31YEwpkMuc5THy2PSt5bDMsktWQcFF8syAmRUapSCGu8ED9W6oDMSgv6Zz8idoc4a6mr8BDzTJY47LJhkJ8UB7WEGuduB
</pre></div>
</div>
</div>
</div>
<p>上面生成的主私钥和公钥我们成为 <strong>m</strong> (master的意思)。那我们怎么派生出更多的私钥和公钥呢？</p>
<p>下面我们来生成 <strong>m/0</strong> (这个类似一个路径的感觉)。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">child_number</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">my_hmac</span><span class="p">(</span><span class="n">master_chain_code</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">),</span> <span class="n">master_public_key</span> <span class="o">+</span> <span class="n">child_number</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">))</span>
<span class="c1"># 核心在这里，父节点的私钥影响了字节点的私钥</span>
<span class="n">child_private_key</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">I</span><span class="p">[:</span><span class="mi">32</span><span class="p">],</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">master_private_key</span><span class="p">)</span> <span class="o">%</span> <span class="n">secp256k1_n</span>
<span class="n">child_chain_code</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">I</span><span class="p">[</span><span class="mi">32</span><span class="p">:],</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
<span class="n">child_public_point</span> <span class="o">=</span> <span class="n">priv_key_to_pub_key</span><span class="p">(</span><span class="n">child_private_key</span><span class="p">)</span>
<span class="n">child_public_key</span> <span class="o">=</span> <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x02</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">child_public_point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x03</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">child_public_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;ripemd160&#39;</span><span class="p">)</span>
<span class="n">tmp</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">child_public_key</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">())</span>
<span class="n">hash160_child_public_key</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
<span class="n">child_fingerprint</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">hash160_child_public_key</span><span class="p">[:</span><span class="mi">4</span><span class="p">],</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>

<span class="n">serialized_mainnet_child_private_key</span> <span class="o">=</span> <span class="n">base58</span><span class="o">.</span><span class="n">b58encode</span><span class="p">(</span><span class="n">serialize_mainnet_private_key</span><span class="p">(</span><span class="n">child_private_key</span><span class="p">,</span> <span class="n">child_chain_code</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">master_fingerprint</span><span class="p">,</span> <span class="n">child_number</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;child_private_key: </span><span class="si">{</span><span class="n">serialized_mainnet_child_private_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">serialized_mainnet_child_private_key</span> <span class="o">==</span> <span class="s2">&quot;xprv9vHkqa6EV4sPZHYqZznhT2NPtPCjKuDKGY38FBWLvgaDx45zo9WQRUT3dKYnjwih2yJD9mkrocEZXo1ex8G81dwSM1fwqWpWkeS3v86pgKt&quot;</span>

<span class="n">serialized_mainnet_child_public_point</span> <span class="o">=</span> <span class="n">base58</span><span class="o">.</span><span class="n">b58encode</span><span class="p">(</span><span class="n">serialize_mainnet_public_point</span><span class="p">(</span><span class="n">child_public_point</span><span class="p">,</span> <span class="n">child_chain_code</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">master_fingerprint</span><span class="p">,</span> <span class="n">child_number</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;child_public_point: </span><span class="si">{</span><span class="n">serialized_mainnet_child_public_point</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">serialized_mainnet_child_public_point</span> <span class="o">==</span> <span class="s2">&quot;xpub69H7F5d8KSRgmmdJg2KhpAK8SR3DjMwAdkxj3ZuxV27CprR9LgpeyGmXUbC6wb7ERfvrnKZjXoUmmDznezpbZb7ap6r1D3tgFxHmwMkQTPH&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>child_private_key: xprv9vHkqa6EV4sPZHYqZznhT2NPtPCjKuDKGY38FBWLvgaDx45zo9WQRUT3dKYnjwih2yJD9mkrocEZXo1ex8G81dwSM1fwqWpWkeS3v86pgKt
child_public_point: xpub69H7F5d8KSRgmmdJg2KhpAK8SR3DjMwAdkxj3ZuxV27CprR9LgpeyGmXUbC6wb7ERfvrnKZjXoUmmDznezpbZb7ap6r1D3tgFxHmwMkQTPH
</pre></div>
</div>
</div>
</div>
<p>如上，我们就可以得到很多的衍生私钥和公钥，他们可以识别为</p>
<ul class="simple">
<li><p><strong>m</strong></p></li>
<li><p><strong>m/0</strong> , <strong>m/1</strong> , …</p></li>
<li><p><strong>m/0/0</strong> , … , <strong>m/1/0</strong></p></li>
<li><p>…</p></li>
</ul>
<p>在上述的衍生过程中，我们已知父节点的私钥以及公钥，从而可以容易的衍生出子节点的私钥以及公钥。这里更有意思的是，如果我们只知道父节点的公钥，我们能够得到子节点的信息么？为什么这个很重要，可以考虑这样的应用场景。父节点（或者主节点）的私钥存在冷钱包里面，但是其公钥是放在热钱包里面的，方便收款和查看余额，如果能够直接从父节点的公钥得到子节点的公钥，那我们就可以方便创建更多地址了。</p>
<p>如果理解一下上面的衍生过程，我们可以看出，这个想法是可以实现的。上面的衍生过程可以看作这样几个子过程:</p>
<ol class="arabic simple">
<li><p>master_public_point, master_chain_code -&gt; I</p></li>
<li><p>I -&gt; child_chain_code</p></li>
<li><p>I + master_private_key -&gt; child_private_key</p></li>
<li><p>child_private_key -&gt; child_public_point</p></li>
</ol>
<p>3和4可以结合起来得到:</p>
<ol class="arabic simple">
<li><p>master_public_point, master_chain_code -&gt; I</p></li>
<li><p>I -&gt; child_chain_code</p></li>
<li><p>I + master_public_point -&gt; child_public_point</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_I</span> <span class="o">=</span> <span class="n">my_hmac</span><span class="p">(</span><span class="n">master_chain_code</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">),</span> <span class="n">master_public_key</span> <span class="o">+</span> <span class="n">child_number</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">))</span>
<span class="n">new_child_public_point</span> <span class="o">=</span> <span class="n">secp256k1_add</span><span class="p">(</span><span class="n">priv_key_to_pub_key</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">new_I</span><span class="p">[:</span><span class="mi">32</span><span class="p">],</span> <span class="s1">&#39;big&#39;</span><span class="p">)),</span> <span class="n">master_public_point</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">new_child_public_point</span> <span class="o">==</span> <span class="n">child_public_point</span>
</pre></div>
</div>
</div>
</div>
<p>实际上，BIP0032还搞了一种衍生机制，我猜可能是为隐私的考虑。因为如上所述，从父节点的公钥就可以推测出所有子节点的公钥，那我知道了你的公钥，就可以容易的推算出所有子节点、孙子节点的公钥，从而查看你的余额，一点隐私都没有了。</p>
<p>这种新的机制把 <strong>child_number &gt;= 2^31</strong> 单独拿出来，加以隐私考虑，为了书写方便，这个衍生方式用 <strong>m/0’</strong> 来代表 <strong>child_number=2^31</strong> 。</p>
<p>下面是 <strong>m/0/2147483647’</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grandson_number</span> <span class="o">=</span> <span class="mi">2147483647</span> <span class="o">+</span> <span class="mi">2</span><span class="o">**</span><span class="mi">31</span>
<span class="c1"># 注意这里的区别，如果不知道父节点的私钥，我们是得不到I的数据的</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">my_hmac</span><span class="p">(</span><span class="n">child_chain_code</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">),</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">child_private_key</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">grandson_number</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">))</span>
<span class="n">grandson_private_key</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">I</span><span class="p">[:</span><span class="mi">32</span><span class="p">],</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">child_private_key</span><span class="p">)</span> <span class="o">%</span> <span class="n">secp256k1_n</span>
<span class="n">grandson_chain_code</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">I</span><span class="p">[</span><span class="mi">32</span><span class="p">:],</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
<span class="n">grandson_public_point</span> <span class="o">=</span> <span class="n">priv_key_to_pub_key</span><span class="p">(</span><span class="n">grandson_private_key</span><span class="p">)</span>
<span class="n">grandson_public_key</span> <span class="o">=</span> <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x02</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">grandson_public_point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x03</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">grandson_public_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;ripemd160&#39;</span><span class="p">)</span>
<span class="n">tmp</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">grandson_public_key</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">())</span>
<span class="n">hash160_grandson_public_key</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
<span class="n">grandson_fingerprint</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">hash160_grandson_public_key</span><span class="p">[:</span><span class="mi">4</span><span class="p">],</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>

<span class="n">serialized_mainnet_grandson_private_key</span> <span class="o">=</span> <span class="n">base58</span><span class="o">.</span><span class="n">b58encode</span><span class="p">(</span><span class="n">serialize_mainnet_private_key</span><span class="p">(</span><span class="n">grandson_private_key</span><span class="p">,</span> <span class="n">grandson_chain_code</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">child_fingerprint</span><span class="p">,</span> <span class="n">grandson_number</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;grandson_private_key: </span><span class="si">{</span><span class="n">serialized_mainnet_grandson_private_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">serialized_mainnet_grandson_private_key</span> <span class="o">==</span> <span class="s2">&quot;xprv9wSp6B7kry3Vj9m1zSnLvN3xH8RdsPP1Mh7fAaR7aRLcQMKTR2vidYEeEg2mUCTAwCd6vnxVrcjfy2kRgVsFawNzmjuHc2YmYRmagcEPdU9&quot;</span>

<span class="n">serialized_mainnet_grandson_public_point</span> <span class="o">=</span> <span class="n">base58</span><span class="o">.</span><span class="n">b58encode</span><span class="p">(</span><span class="n">serialize_mainnet_public_point</span><span class="p">(</span><span class="n">grandson_public_point</span><span class="p">,</span> <span class="n">grandson_chain_code</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">child_fingerprint</span><span class="p">,</span> <span class="n">grandson_number</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;grandson_public_point: </span><span class="si">{</span><span class="n">serialized_mainnet_grandson_public_point</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">serialized_mainnet_grandson_public_point</span> <span class="o">==</span> <span class="s2">&quot;xpub6ASAVgeehLbnwdqV6UKMHVzgqAG8Gr6riv3Fxxpj8ksbH9ebxaEyBLZ85ySDhKiLDBrQSARLq1uNRts8RuJiHjaDMBU4Zn9h8LZNnBC5y4a&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>grandson_private_key: xprv9wSp6B7kry3Vj9m1zSnLvN3xH8RdsPP1Mh7fAaR7aRLcQMKTR2vidYEeEg2mUCTAwCd6vnxVrcjfy2kRgVsFawNzmjuHc2YmYRmagcEPdU9
grandson_public_point: xpub6ASAVgeehLbnwdqV6UKMHVzgqAG8Gr6riv3Fxxpj8ksbH9ebxaEyBLZ85ySDhKiLDBrQSARLq1uNRts8RuJiHjaDMBU4Zn9h8LZNnBC5y4a
</pre></div>
</div>
</div>
</div>
</section>
<section id="bither-net">
<h2>bither.net钱包<a class="headerlink" href="#bither-net" title="Permalink to this heading">#</a></h2>
<p><a class="reference external" href="https://bither.net">https://bither.net</a></p>
<p>基于版本1.4.8: 4d8770d4c24620bf40559ae402148d526ea488b0069b7347fe0903fec9a73b51 bither-desktop.jar</p>
<p>做个小实验。首先我们用bither生成一个HDM热钱包，相关数据如下。根据 BIP0044，我们猜测这个地址的衍生路径是 <strong>m/44’/0’/0’/0/0</strong> ，我们来验证一下。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bither_mnemnic_words</span> <span class="o">=</span> <span class="s2">&quot;peanut-test-swear-eager-obtain-tuition-plate-tool-butter-dragon-identify-army&quot;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
<span class="n">bither_mnemnic_words_as_idx_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">mnemonic_word_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">bither_mnemnic_words</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)]</span>
<span class="n">bither_mnemnic_words_as_bin_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">:</span><span class="s2">011b</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">bither_mnemnic_words_as_idx_list</span><span class="p">])</span>
<span class="n">bither_mnemnic_words_as_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bither_mnemnic_words_as_bin_string</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">bither_mnemnic_words_as_int</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;bither_mnemnic_words_as_int: 0x</span><span class="si">{</span><span class="n">bither_mnemnic_words_as_int</span><span class="si">:</span><span class="s2">032x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">bither_first_btc_address</span> <span class="o">=</span> <span class="s2">&quot;1Ntu2p29uSgkjvHihLrDvnKwWxx7VnZ6Lv&quot;</span>

<span class="k">def</span> <span class="nf">get_fingerprint</span><span class="p">(</span><span class="n">compressed_public_key</span><span class="p">):</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;ripemd160&#39;</span><span class="p">)</span>
    <span class="n">tmp</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">compressed_public_key</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">())</span>
    <span class="k">return</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">digest</span><span class="p">()[:</span><span class="mi">4</span><span class="p">],</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_address</span><span class="p">(</span><span class="n">compressed_public_key</span><span class="p">):</span>
    <span class="n">hashed_pub_key</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">compressed_public_key</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>

    <span class="n">ripemd160_hasher</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;ripemd160&#39;</span><span class="p">)</span>
    <span class="n">ripemd160_hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hashed_pub_key</span><span class="p">)</span>
    <span class="n">ripemd160_pub_key</span> <span class="o">=</span> <span class="n">ripemd160_hasher</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>

    <span class="n">ripemd160_pub_key_with_version</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">ripemd160_pub_key</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span> <span class="c1"># 添加版本号</span>

    <span class="n">hashed_ripemd160_pub_key_with_version</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">ripemd160_pub_key_with_version</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>

    <span class="n">hashed_twice_ripemd160_pub_key_with_version</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">hashed_ripemd160_pub_key_with_version</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>

    <span class="n">checksum</span> <span class="o">=</span> <span class="n">hashed_twice_ripemd160_pub_key_with_version</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>

    <span class="n">address</span> <span class="o">=</span> <span class="n">ripemd160_pub_key_with_version</span> <span class="o">+</span> <span class="n">checksum</span>
    <span class="k">return</span> <span class="n">base58</span><span class="o">.</span><span class="n">b58encode</span><span class="p">(</span><span class="n">address</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">mnemonic_to_key</span><span class="p">(</span><span class="n">mnemonic</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">extra_phrase</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="c1"># extra_phrase used later</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="n">my_pbkdf2</span><span class="p">(</span><span class="n">mnemonic</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;mnemonic&quot;</span> <span class="o">+</span> <span class="n">extra_phrase</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">my_hmac</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;Bitcoin seed&quot;</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span>
    <span class="n">I_L</span> <span class="o">=</span> <span class="n">I</span><span class="p">[:</span><span class="mi">32</span><span class="p">]</span>
    <span class="n">I_R</span> <span class="o">=</span> <span class="n">I</span><span class="p">[</span><span class="mi">32</span><span class="p">:]</span>
    <span class="n">private_key</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">I_L</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
    <span class="n">chain_code</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">I_R</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
    <span class="n">public_key</span> <span class="o">=</span> <span class="n">priv_key_to_pub_key</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>
    <span class="n">compressed_public_key</span> <span class="o">=</span> <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x02</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">public_key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x03</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">public_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
    <span class="n">fingerprint</span> <span class="o">=</span> <span class="n">get_fingerprint</span><span class="p">(</span><span class="n">compressed_public_key</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">child_number</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">child_number</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">31</span><span class="p">:</span>
            <span class="c1"># normal child</span>
            <span class="n">I</span> <span class="o">=</span> <span class="n">my_hmac</span><span class="p">(</span><span class="n">chain_code</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">),</span> <span class="n">compressed_public_key</span> <span class="o">+</span> <span class="n">child_number</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># hardened child</span>
            <span class="n">I</span> <span class="o">=</span> <span class="n">my_hmac</span><span class="p">(</span><span class="n">chain_code</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">),</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">private_key</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">child_number</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">))</span>
        <span class="n">private_key</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">I</span><span class="p">[:</span><span class="mi">32</span><span class="p">],</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">private_key</span><span class="p">)</span> <span class="o">%</span> <span class="n">secp256k1_n</span>
        <span class="n">chain_code</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">I</span><span class="p">[</span><span class="mi">32</span><span class="p">:],</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
        <span class="n">public_key</span> <span class="o">=</span> <span class="n">priv_key_to_pub_key</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>
        <span class="n">compressed_public_key</span> <span class="o">=</span> <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x02</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">public_key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x03</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">public_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
        <span class="n">fingerprint</span> <span class="o">=</span> <span class="n">get_fingerprint</span><span class="p">(</span><span class="n">compressed_public_key</span><span class="p">)</span>

    <span class="n">address</span> <span class="o">=</span> <span class="n">get_address</span><span class="p">(</span><span class="n">compressed_public_key</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;private_key&quot;</span><span class="p">:</span> <span class="n">private_key</span><span class="p">,</span> <span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="n">address</span><span class="p">,</span> <span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="n">seed</span><span class="p">}</span>

<span class="n">computed_bither_info</span> <span class="o">=</span> <span class="n">mnemonic_to_key</span><span class="p">(</span><span class="n">bither_mnemnic_words</span><span class="p">,</span> <span class="p">[</span><span class="mi">44</span><span class="o">+</span><span class="mi">2</span><span class="o">**</span><span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="o">+</span><span class="mi">2</span><span class="o">**</span><span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="o">+</span><span class="mi">2</span><span class="o">**</span><span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">computed_bither_first_btc_address</span> <span class="o">=</span> <span class="n">computed_bither_info</span><span class="p">[</span><span class="s2">&quot;address&quot;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;computed_bither_first_btc_address: </span><span class="si">{</span><span class="n">computed_bither_first_btc_address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">computed_bither_first_btc_address</span> <span class="o">==</span> <span class="n">bither_first_btc_address</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>bither_mnemnic_words_as_int: 0xa1fbf36e227989d4698f251f4841c206
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>computed_bither_first_btc_address: 1Ntu2p29uSgkjvHihLrDvnKwWxx7VnZ6Lv
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
<p>地址果然是对的。</p>
<p>bither钱包除了可以导出助记词之外，实际上还可以导出一个 <strong>HD账户种子二维码</strong> 的东西，这玩意儿是加密过的种子，但是要注意是生成助记词的那个随机数，用这个随机数就可以生成助记词。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bither_seed_qrcode_content</span> <span class="o">=</span> <span class="s2">&quot;3D25EF489FCEA9BD9470C8254E65DD3AC4C6AFCD60882F3050065B2CB16268FF/DF48C3E83CB3D59707F87B6544AE6BF6/03FB2B4121FBDB4E07&quot;</span>
<span class="n">bither_encrypted_seed</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">bither_seed_qrcode_content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">bither_iv</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">bither_seed_qrcode_content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">bither_salt</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">bither_seed_qrcode_content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">bither_password</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">1</span><span class="se">\x00</span><span class="s2">2</span><span class="se">\x00</span><span class="s2">3</span><span class="se">\x00</span><span class="s2">4</span><span class="se">\x00</span><span class="s2">5</span><span class="se">\x00</span><span class="s2">q</span><span class="se">\x00</span><span class="s2">w</span><span class="se">\x00</span><span class="s2">e</span><span class="se">\x00</span><span class="s2">r</span><span class="se">\x00</span><span class="s2">t&quot;</span> <span class="c1"># 我们随便设置一个密码，注意这里的编码 WTF</span>

<span class="kn">from</span> <span class="nn">cryptography.hazmat.backends</span> <span class="kn">import</span> <span class="n">default_backend</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives</span> <span class="kn">import</span> <span class="n">padding</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.ciphers</span> <span class="kn">import</span> <span class="n">Cipher</span><span class="p">,</span> <span class="n">algorithms</span><span class="p">,</span> <span class="n">modes</span>

<span class="k">def</span> <span class="nf">encrypt_bither_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">iv</span><span class="p">,</span> <span class="n">salt</span><span class="p">):</span>
    <span class="n">salt</span> <span class="o">=</span> <span class="n">salt</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">iv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">salt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span>

    <span class="n">aes_key</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">scrypt</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="n">salt</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">16384</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dklen</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>

    <span class="n">cipher</span> <span class="o">=</span> <span class="n">Cipher</span><span class="p">(</span><span class="n">algorithms</span><span class="o">.</span><span class="n">AES</span><span class="p">(</span><span class="n">aes_key</span><span class="p">),</span> <span class="n">modes</span><span class="o">.</span><span class="n">CBC</span><span class="p">(</span><span class="n">iv</span><span class="p">),</span> <span class="n">backend</span><span class="o">=</span><span class="n">default_backend</span><span class="p">())</span>

    <span class="n">encryptor</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">encryptor</span><span class="p">()</span>

    <span class="n">padder</span> <span class="o">=</span> <span class="n">padding</span><span class="o">.</span><span class="n">PKCS7</span><span class="p">(</span><span class="n">algorithms</span><span class="o">.</span><span class="n">AES</span><span class="o">.</span><span class="n">block_size</span><span class="p">)</span><span class="o">.</span><span class="n">padder</span><span class="p">()</span>

    <span class="n">padded_data</span> <span class="o">=</span> <span class="n">padder</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span> <span class="o">+</span> <span class="n">padder</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
    <span class="n">encrypted_data</span> <span class="o">=</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">padded_data</span><span class="p">)</span> <span class="o">+</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">encrypted_data</span>

<span class="n">ret</span> <span class="o">=</span> <span class="n">encrypt_bither_seed</span><span class="p">(</span><span class="n">bither_mnemnic_words_as_int</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s2">&quot;big&quot;</span><span class="p">),</span> <span class="n">bither_password</span><span class="p">,</span> <span class="n">bither_iv</span><span class="p">,</span> <span class="n">bither_salt</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">ret</span> <span class="o">==</span> <span class="n">bither_encrypted_seed</span>

<span class="k">def</span> <span class="nf">decrypt_bither_seed</span><span class="p">(</span><span class="n">encrypted_seed</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">iv</span><span class="p">,</span> <span class="n">salt</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">salt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="c1"># IS_COMPRESSED_FLAG + IS_FROMXRANDOM_FLAG</span>
    <span class="n">salt</span> <span class="o">=</span> <span class="n">salt</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">encrypted_seed</span><span class="p">)</span> <span class="o">==</span> <span class="mi">32</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">iv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">salt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span>

    <span class="n">aes_key</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">scrypt</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="n">salt</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">16384</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dklen</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>

    <span class="n">cipher</span> <span class="o">=</span> <span class="n">Cipher</span><span class="p">(</span><span class="n">algorithms</span><span class="o">.</span><span class="n">AES</span><span class="p">(</span><span class="n">aes_key</span><span class="p">),</span> <span class="n">modes</span><span class="o">.</span><span class="n">CBC</span><span class="p">(</span><span class="n">iv</span><span class="p">),</span> <span class="n">backend</span><span class="o">=</span><span class="n">default_backend</span><span class="p">())</span>

    <span class="n">decryptor</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">decryptor</span><span class="p">()</span>

    <span class="n">decrypted_padded_bytes</span> <span class="o">=</span> <span class="n">decryptor</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">encrypted_seed</span><span class="p">)</span> <span class="o">+</span> <span class="n">decryptor</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">decrypted_padded_bytes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">32</span>

    <span class="n">unpadder</span> <span class="o">=</span> <span class="n">padding</span><span class="o">.</span><span class="n">PKCS7</span><span class="p">(</span><span class="n">algorithms</span><span class="o">.</span><span class="n">AES</span><span class="o">.</span><span class="n">block_size</span><span class="p">)</span><span class="o">.</span><span class="n">unpadder</span><span class="p">()</span>

    <span class="n">decrypted_bytes</span> <span class="o">=</span> <span class="n">unpadder</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">decrypted_padded_bytes</span><span class="p">)</span> <span class="o">+</span> <span class="n">unpadder</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">decrypted_bytes</span>

<span class="n">ret</span> <span class="o">=</span> <span class="n">decrypt_bither_seed</span><span class="p">(</span><span class="n">bither_encrypted_seed</span><span class="p">,</span> <span class="n">bither_password</span><span class="p">,</span> <span class="n">bither_iv</span><span class="p">,</span> <span class="n">bither_salt</span><span class="p">)</span>
<span class="c1">#print(f&quot;decrypted_mnemonic_seeds: 0x{int.from_bytes(ret, &#39;big&#39;):032x}&quot;)</span>
<span class="k">assert</span> <span class="n">ret</span> <span class="o">==</span> <span class="n">bither_mnemnic_words_as_int</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s2">&quot;big&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="bitherhd">
<h3>bither非HD模式<a class="headerlink" href="#bitherhd" title="Permalink to this heading">#</a></h3>
<p>除了上述的这种复杂的所谓HD模式（先生成助记词，然后生成一个seed，然后再生成各个地址）之外，bither还有一种简单直接的模式，就是独立的一个一个的地址，相互没有任何关系。</p>
<p>在这种模式之下，用户的私钥可以直接导出，也可以先加密后导出。</p>
<p><a class="reference external" href="https://en.bitcoin.it/wiki/Wallet_import_format">https://en.bitcoin.it/wiki/Wallet_import_format</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bither_normal_address</span> <span class="o">=</span> <span class="s2">&quot;1MnqqRyVjvRJKJE1GjWexbK2E8jatwyVYW&quot;</span>
<span class="c1"># WIF private key for compressed public key</span>
<span class="n">bither_normal_address_private_key_str</span> <span class="o">=</span> <span class="s2">&quot;L5AjnXZbfZXTwqyYZbEtpfKiUtWbfxHC14djNixeoML9bigbt6WV&quot;</span>

<span class="k">def</span> <span class="nf">wif_to_address</span><span class="p">(</span><span class="n">wif</span><span class="p">):</span>
    <span class="c1"># first byte is 0x80 for mainnet</span>
    <span class="c1"># last 4 bytes are the checksum</span>
    <span class="c1"># last 5th byte is 0x01 for compressed public key</span>
    <span class="n">private_key</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">base58</span><span class="o">.</span><span class="n">b58decode</span><span class="p">(</span><span class="n">wif</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">],</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
    <span class="n">public_point</span> <span class="o">=</span> <span class="n">priv_key_to_pub_key</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>
    <span class="n">compressed_public_key</span> <span class="o">=</span> <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x02</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">public_point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x03</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">public_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">get_address</span><span class="p">(</span><span class="n">compressed_public_key</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">wif_to_address</span><span class="p">(</span><span class="n">bither_normal_address_private_key_str</span><span class="p">)</span> <span class="o">==</span> <span class="n">bither_normal_address</span>

<span class="n">bither_encrypted_wif</span> <span class="o">=</span> <span class="s2">&quot;E8BE291DD03FBDBBFC916348EB37160EEFF43B1ADF7122C4557E4BA2792078726FCE930FA9755A417C95B8127A16E332/9C118D1BA7E529E66E4993D064E33FBE/0376CBFC3EB2B0E8BA&quot;</span>
<span class="n">bither_encrypted_wif</span> <span class="o">=</span> <span class="n">bither_encrypted_wif</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="n">bither_encrypted_wif_bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">bither_encrypted_wif</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">bither_encrypted_wif_iv</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">bither_encrypted_wif</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">bither_encrypted_wif_salt</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">bither_encrypted_wif</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">decrypt_bither_wif</span><span class="p">(</span><span class="n">encrypted_wif</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">iv</span><span class="p">,</span> <span class="n">salt</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">salt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="c1"># IS_COMPRESSED_FLAG + IS_FROMXRANDOM_FLAG</span>
    <span class="n">salt</span> <span class="o">=</span> <span class="n">salt</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">encrypted_wif</span><span class="p">)</span> <span class="o">==</span> <span class="mi">48</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">iv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">salt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span>

    <span class="n">aes_key</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">scrypt</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="n">salt</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">16384</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dklen</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>

    <span class="n">cipher</span> <span class="o">=</span> <span class="n">Cipher</span><span class="p">(</span><span class="n">algorithms</span><span class="o">.</span><span class="n">AES</span><span class="p">(</span><span class="n">aes_key</span><span class="p">),</span> <span class="n">modes</span><span class="o">.</span><span class="n">CBC</span><span class="p">(</span><span class="n">iv</span><span class="p">),</span> <span class="n">backend</span><span class="o">=</span><span class="n">default_backend</span><span class="p">())</span>

    <span class="n">decryptor</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">decryptor</span><span class="p">()</span>

    <span class="n">decrypted_padded_bytes</span> <span class="o">=</span> <span class="n">decryptor</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">encrypted_wif</span><span class="p">)</span> <span class="o">+</span> <span class="n">decryptor</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">decrypted_padded_bytes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">48</span>

    <span class="n">unpadder</span> <span class="o">=</span> <span class="n">padding</span><span class="o">.</span><span class="n">PKCS7</span><span class="p">(</span><span class="n">algorithms</span><span class="o">.</span><span class="n">AES</span><span class="o">.</span><span class="n">block_size</span><span class="p">)</span><span class="o">.</span><span class="n">unpadder</span><span class="p">()</span>

    <span class="n">decrypted_bytes</span> <span class="o">=</span> <span class="n">unpadder</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">decrypted_padded_bytes</span><span class="p">)</span> <span class="o">+</span> <span class="n">unpadder</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">decrypted_bytes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">32</span>

    <span class="k">return</span> <span class="n">decrypted_bytes</span>

<span class="n">wif_bytes</span> <span class="o">=</span> <span class="n">decrypt_bither_wif</span><span class="p">(</span><span class="n">bither_encrypted_wif_bytes</span><span class="p">,</span> <span class="n">bither_password</span><span class="p">,</span> <span class="n">bither_encrypted_wif_iv</span><span class="p">,</span> <span class="n">bither_encrypted_wif_salt</span><span class="p">)</span>
<span class="n">expected_wif_bytes</span> <span class="o">=</span> <span class="n">base58</span><span class="o">.</span><span class="n">b58decode</span><span class="p">(</span><span class="n">bither_normal_address_private_key_str</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
<span class="k">assert</span> <span class="n">wif_bytes</span> <span class="o">==</span> <span class="n">expected_wif_bytes</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="ledger-nano-s-plus">
<h2>Ledger Nano S Plus<a class="headerlink" href="#ledger-nano-s-plus" title="Permalink to this heading">#</a></h2>
<p>有了bither.net的经验，貌似一切就容易了。注意参考 <a class="reference external" href="https://en.bitcoin.it/wiki/BIP_0044">https://en.bitcoin.it/wiki/BIP_0044</a> 。我们来初始化一个Ledger设备，然后检查一切是不是如同 <a class="reference external" href="http://bither.net">bither.net</a> 一样。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ledger_mnemonic_words</span> <span class="o">=</span> <span class="s2">&quot;fabric gaze exchange canvas symbol use swamp arctic resemble label guide angry nature solve laptop exit fuel result hood cactus piece hotel divorce illegal&quot;</span>
<span class="n">ledger_first_btc_address_info_from_computed</span> <span class="o">=</span> <span class="n">mnemonic_to_key</span><span class="p">(</span><span class="n">ledger_mnemonic_words</span><span class="p">,</span> <span class="p">[</span><span class="mi">44</span><span class="o">+</span><span class="mi">2</span><span class="o">**</span><span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="o">+</span><span class="mi">2</span><span class="o">**</span><span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="o">+</span><span class="mi">2</span><span class="o">**</span><span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">ledger_first_btc_address_shown</span> <span class="o">=</span> <span class="s2">&quot;16MoycEPk6ZUGnrR5EkmNJgkap1hnLKcVr&quot;</span>
<span class="k">assert</span> <span class="n">ledger_first_btc_address_info_from_computed</span><span class="p">[</span><span class="s2">&quot;address&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ledger_first_btc_address_shown</span>
</pre></div>
</div>
</div>
</div>
<p>看得出来，ledger和bither之间毫无区别，都是遵守同样几个BIP，以及相同的衍生path，整个计算过程也毫无二致。</p>
<p>不过ledger还有个一个高级功能，就是可以设置一个密码，从而得到完全不同的地址集合。我们来试一下</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ledger_extra_password</span> <span class="o">=</span> <span class="s2">&quot;12345&quot;</span>
<span class="n">ledger_extra_btc_address_info_from_computed</span> <span class="o">=</span> <span class="n">mnemonic_to_key</span><span class="p">(</span><span class="n">ledger_mnemonic_words</span><span class="p">,</span> <span class="p">[</span><span class="mi">44</span><span class="o">+</span><span class="mi">2</span><span class="o">**</span><span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="o">+</span><span class="mi">2</span><span class="o">**</span><span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="o">+</span><span class="mi">2</span><span class="o">**</span><span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">extra_phrase</span><span class="o">=</span><span class="n">ledger_extra_password</span><span class="p">)</span>
<span class="n">ledger_extra_btc_address_shown</span> <span class="o">=</span> <span class="s2">&quot;1PB24uzHD786A5x6xSKjLtBBewnvapC2rk&quot;</span>
<span class="k">assert</span> <span class="n">ledger_extra_btc_address_info_from_computed</span><span class="p">[</span><span class="s2">&quot;address&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ledger_extra_btc_address_shown</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="btc">
<h2>手搓BTC<a class="headerlink" href="#btc" title="Permalink to this heading">#</a></h2>
<p>由上可知，如果遵循BIP0039，我们实际上需要做的是，首先生成若干比特的随机数，然后从2048个助记词中挑选出助记词列表。</p>
<p>如果我们不相信钱包的随机数生成机制，我们是不是可以手工完成上述过程？貌似是可以的，但需要仔细分析一下。</p>
<p>对Ledger钱包而言，我们要生成的助记词是24个，对应 <code class="docutils literal notranslate"><span class="pre">24</span> <span class="pre">*</span> <span class="pre">11</span> <span class="pre">=</span> <span class="pre">264</span></code> 比特，其中 256 比特来自随机数，另外8比特是校验码，也就是checksum。这个校验码是通过sha256哈希计算而得的，这个部分我们要手工计算就困难了。</p>
<p>类似分析bither钱包，我们要生成的助记词是12个，对应 <code class="docutils literal notranslate"><span class="pre">12</span> <span class="pre">*</span> <span class="pre">11</span> <span class="pre">=</span> <span class="pre">132</span></code> 比特，其中 128 比特来自随机数，另外4比特是校验码。这个校验码同样是通过哈希计算得到的，应该也很难于进行手工计算，对吧？但是，相对于计算哈希，我们可以直接穷举所有的 <code class="docutils literal notranslate"><span class="pre">2</span> <span class="pre">^</span> <span class="pre">4</span> <span class="pre">=</span> <span class="pre">16</span></code> 种不同的校验码，似乎也不算太多？</p>
<p>我们来试一下：</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 我们通过摇骰子来得到随机性，每次摇骰子，如果得到的数字是 5和6 就丢弃，重新摇骰子</span>
<span class="n">dice_results</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
<span class="n">dice_entropy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dice_results</span><span class="p">]),</span> <span class="mi">4</span><span class="p">)</span>

<span class="k">for</span> <span class="n">checksum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">entropy</span> <span class="o">=</span> <span class="n">dice_entropy</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="n">checksum</span>
    <span class="n">mnemonic</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
        <span class="n">mnemonic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mnemonic_word_list</span><span class="p">[</span><span class="n">entropy</span> <span class="o">&amp;</span> <span class="mi">2047</span><span class="p">])</span>
        <span class="n">entropy</span> <span class="o">=</span> <span class="n">entropy</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span>
    <span class="n">mnemonic</span> <span class="o">=</span> <span class="n">mnemonic</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">mnemonic</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mnemonic</span><span class="p">)</span>
    <span class="n">first_address</span> <span class="o">=</span> <span class="n">mnemonic_to_key</span><span class="p">(</span><span class="n">mnemonic</span><span class="p">,</span> <span class="p">[</span><span class="mi">44</span><span class="o">+</span><span class="mi">2</span><span class="o">**</span><span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="o">+</span><span class="mi">2</span><span class="o">**</span><span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="o">+</span><span class="mi">2</span><span class="o">**</span><span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])[</span><span class="s2">&quot;address&quot;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mnemonic for checksum=</span><span class="si">{</span><span class="n">checksum</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">mnemonic</span><span class="si">}</span><span class="s2"> </span><span class="se">\t</span><span class="s2">first_address: </span><span class="si">{</span><span class="n">first_address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mnemonic for checksum=0: olive pride shallow visit prison metal license dress wealth describe aware present 	first_address: 1HtP3Ck78jbbvDDFBuve1jjTJE7t64mDyC
mnemonic for checksum=1: olive pride shallow visit prison metal license dress wealth describe aware pretty 	first_address: 1MX49nSeQ1DXAa5g2Qech1DrshghM7QS8C
mnemonic for checksum=2: olive pride shallow visit prison metal license dress wealth describe aware prevent 	first_address: 1CsnKcS3sUrivoThpW5tvr97nszaMJVtxt
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mnemonic for checksum=3: olive pride shallow visit prison metal license dress wealth describe aware price 	first_address: 1MVx4x8WzDPTemkSbYuGJS14EGVqL53Lig
mnemonic for checksum=4: olive pride shallow visit prison metal license dress wealth describe aware pride 	first_address: 1FpF2kY7nZk5jc7fZCob6XkGQMKmexb7V4
mnemonic for checksum=5: olive pride shallow visit prison metal license dress wealth describe aware primary 	first_address: 1A4RYyEHcgyp6vPH8fvbbcX7rz8VWokMXd
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mnemonic for checksum=6: olive pride shallow visit prison metal license dress wealth describe aware print 	first_address: 1eHGu3LSLVzM67HNSJo2xFvY9xuP1u3cF
mnemonic for checksum=7: olive pride shallow visit prison metal license dress wealth describe aware priority 	first_address: 1CmumQ5EHK9KCMVmPd7SAiKQjX7NDga8Fx
mnemonic for checksum=8: olive pride shallow visit prison metal license dress wealth describe aware prison 	first_address: 1LkYX3WdrhmkiruNaEdXrKRTZkbbrzrpeT
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mnemonic for checksum=9: olive pride shallow visit prison metal license dress wealth describe aware private 	first_address: 1CpfG1KQk7SsMLE4HYLugv27yd6e7FqQfA
mnemonic for checksum=a: olive pride shallow visit prison metal license dress wealth describe aware prize 	first_address: 143L1VZ2P6weU9G8rhpPbgzrd7LftRNinw
mnemonic for checksum=b: olive pride shallow visit prison metal license dress wealth describe aware problem 	first_address: 19Kj2Df1LnE6xZMvZejAtEypKCr3RGbGJy
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mnemonic for checksum=c: olive pride shallow visit prison metal license dress wealth describe aware process 	first_address: 1EKHYbwnkcCciRTFCpT4AkbKfANTvwARWH
mnemonic for checksum=d: olive pride shallow visit prison metal license dress wealth describe aware produce 	first_address: 1C7iKFpJXxRR8gaWvVcqHCKGMw1axvwTMU
mnemonic for checksum=e: olive pride shallow visit prison metal license dress wealth describe aware profit 	first_address: 1D13tVvU6LKdbf5ry4iU7imdhzhsUc4zyV
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mnemonic for checksum=f: olive pride shallow visit prison metal license dress wealth describe aware program 	first_address: 1Na6NXdaPqje9HViVf75R1RzeVo7UqbpXg
</pre></div>
</div>
</div>
</div>
<p>通过手工将上面16组可能的助记词输入到bither钱包中去，我们将知道哪一个校验码才是正确的。</p>
<p>通过不断尝试，答案是几乎到了列表末尾的 <code class="docutils literal notranslate"><span class="pre">checksum=e</span></code>，但是相比计算sha256哈希来说，这个也算是简单多了。</p>
</section>
<section id="multi-sigbtc">
<h2>multi-sig多签存储btc<a class="headerlink" href="#multi-sigbtc" title="Permalink to this heading">#</a></h2>
<p>如果只使用单独的一个钱包来存币，上面介绍的机制貌似已经够了。但有时候我们不免会有一个疑问，如果这个钱包出问题了怎么办？比如要是bither钱包出bug了，比如随机数生成过程出问题了，或者是签名交易的时候出bug泄漏私钥了，怎么办？要是Ledger钱包固件出问题了，比如官方被黑了，固件出bug了，怎么办？一个容易想到的答案是，如果我们能够同时使用这两个钱包，甚至多个钱包的安全性，似乎会更安全一些？</p>
<p>这个可以用比特币的多签机制来解决。下面直接用一个例子来解释。</p>
<p><a class="reference external" href="https://en.bitcoin.it/wiki/OP_CHECKMULTISIG">https://en.bitcoin.it/wiki/OP_CHECKMULTISIG</a></p>
<p><a class="reference external" href="https://mempool.space/zh/tx/d3adb18d5e118bb856fbea4b1af936602454b44a98fc6c823aedc858b491fc13">https://mempool.space/zh/tx/d3adb18d5e118bb856fbea4b1af936602454b44a98fc6c823aedc858b491fc13</a> 是一个 <code class="docutils literal notranslate"><span class="pre">2/3</span></code> 的例子。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># raw data from https://bitaps.com/raw/transaction/d3adb18d5e118bb856fbea4b1af936602454b44a98fc6c823aedc858b491fc13</span>

<span class="n">ms_recv_tx</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="mh">0x01</span><span class="p">,</span> <span class="c1"># raw is 01000000</span>
    <span class="s2">&quot;flag&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># for legacy tx, flag is None</span>
    <span class="s2">&quot;in_count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="c1"># raw is 01</span>
    <span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;tx&quot;</span><span class="p">:</span> <span class="mh">0x1b16e4a8af0831da62d8baae47636e49060049948a3d9b8b9b78eafb853b5a2b</span><span class="p">,</span>
            <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="c1"># raw is 01000000</span>
            <span class="s2">&quot;script_size&quot;</span><span class="p">:</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="c1"># raw is 8b</span>
            <span class="s2">&quot;script_sig&quot;</span><span class="p">:</span> <span class="mh">0x48304502204c3da378d8323a7233892b8050f738da69daf765ddc0d9815d9ad352286b70c2022100dff11c19338daa85ec5b124434de3b4378ebe8c56950348d5f66197af1d04f09014104910ae6c9b41b04d366ea54e920663c691843bb83ef7336cd6a0f79b0ac82ee38d2ca23a24adc2348d82c8ca13f0db885712493e89d88551118a7e80ff66ab23c</span><span class="p">,</span>
            <span class="s2">&quot;seq_no&quot;</span><span class="p">:</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="c1"># raw is ffffffff</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="s2">&quot;out_count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="c1"># raw is 01</span>
    <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mi">9980000</span><span class="p">,</span> <span class="c1"># raw is 6048980000000000</span>
            <span class="s2">&quot;script_size&quot;</span><span class="p">:</span> <span class="mh">0x17</span><span class="p">,</span> <span class="c1"># raw is 17</span>
            <span class="s2">&quot;script&quot;</span><span class="p">:</span> <span class="mh">0xa914b4acb9d78d6a6256964a60484c95de490eaaae7587</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="s2">&quot;lock_time&quot;</span><span class="p">:</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1"># raw is 00000000</span>
<span class="p">}</span>

<span class="c1"># 主要看 output[0].script</span>
<span class="c1"># a914b4acb9d78d6a6256964a60484c95de490eaaae7587</span>
<span class="n">output_script</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;OP_HASH160&quot;</span><span class="p">,</span> <span class="c1"># 0xa9</span>
    <span class="s2">&quot;0x14&quot;</span><span class="p">,</span> <span class="c1"># 20 bytes</span>
    <span class="s2">&quot;0xb4acb9d78d6a6256964a60484c95de490eaaae75&quot;</span><span class="p">,</span> <span class="c1"># 20 bytes</span>
    <span class="s2">&quot;OP_EQUAL&quot;</span><span class="p">,</span> <span class="c1"># 0x87</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>关键是看这个 <code class="docutils literal notranslate"><span class="pre">0xb4acb9d78d6a6256964a60484c95de490eaaae75</span></code> 代表的是什么。</p>
<p>首先参考 BIP0013 和 BIP0016，我们可以算出这个hash对应的收款地址是：</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p2sh_script_hash</span> <span class="o">=</span> <span class="mh">0xb4acb9d78d6a6256964a60484c95de490eaaae75</span>
<span class="n">p2sh_address</span> <span class="o">=</span> <span class="s2">&quot;3JALUHKvqB7NToPA2jALntCUWmvsgYMyGj&quot;</span>

<span class="k">def</span> <span class="nf">p2sh_script_hash_to_address</span><span class="p">(</span><span class="n">p2sh_script_hash</span><span class="p">):</span>
    <span class="n">hash_as_bytes</span> <span class="o">=</span> <span class="n">p2sh_script_hash</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
    <span class="n">bytes_with_version</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x05</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">hash_as_bytes</span>
    <span class="n">checksum</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">bytes_with_version</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">())</span><span class="o">.</span><span class="n">digest</span><span class="p">()[:</span><span class="mi">4</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">base58</span><span class="o">.</span><span class="n">b58encode</span><span class="p">(</span><span class="n">bytes_with_version</span> <span class="o">+</span> <span class="n">checksum</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">p2sh_script_hash_to_address</span><span class="p">(</span><span class="n">p2sh_script_hash</span><span class="p">)</span> <span class="o">==</span> <span class="n">p2sh_address</span>
</pre></div>
</div>
</div>
</div>
<p>那这个脚本具体代表什么呢，光从这个收币的交易是看不出来的，还得从花费这些币的交易中所泄漏的信息才能看出来。</p>
<p><a class="reference external" href="https://mempool.space/zh/tx/cc11ca9e9dc188663c41eb23b15370f68eded56b7ec54dd5bc4f2d2ae93addb2">https://mempool.space/zh/tx/cc11ca9e9dc188663c41eb23b15370f68eded56b7ec54dd5bc4f2d2ae93addb2</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># raw data at https://bitaps.com/raw/transaction/cc11ca9e9dc188663c41eb23b15370f68eded56b7ec54dd5bc4f2d2ae93addb2</span>

<span class="n">ms_send_tx</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="mh">0x01</span><span class="p">,</span> <span class="c1"># raw is 01000000</span>
    <span class="s2">&quot;flag&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># for legacy tx, flag is None</span>
    <span class="s2">&quot;in_count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="c1"># raw is 01</span>
    <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;tx&quot;</span><span class="p">:</span> <span class="mh">0x13fc91b458c8ed3a826cfc984ab454246036f91a4beafb56b88b115e8db1add3</span><span class="p">,</span>
            <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="c1"># raw is 00000000</span>
            <span class="s2">&quot;script_size&quot;</span><span class="p">:</span> <span class="mh">0x015f</span><span class="p">,</span> <span class="c1"># raw is fd5f01</span>
            <span class="s2">&quot;scrpt&quot;</span><span class="p">:</span> <span class="mh">0x00483044022018b88c05ab571cf31bf317a98ed5909cf43218f472bfbeb82b6857d3b1edf4ee0220686627e66b368e298114a097b5814a76fdaac23f7728a42d38415552ba68c8220101493046022100b7a70f4c3b2b5d24475f9664bb77b6046c0251c89b446aad8a86b584b74ed414022100d53dd27b741801a908fdf7c2ee259f444f549b56d7a6c682599ef67b1edb6d24014cc9524104f3d35132084eb1b99b6506178c20adb42d26296012e452e392689bdb6553db33ba24b900000892805de1646821c7b0fb50b3d879c26e2b493b7041e6215356a04104ab4ecc9e8ea2da0562af25bcaede00c4d5a00db60edc17672376decf0a35a34fdc9f1ffad1fb74fd7b1b198b9231c25df88e0769bec49975649b4b3f40adafb04104f7149f270717c00f6cc09b9ce3c22791c4aab1af40a5107aacca85b6f644cc0d84459e308f998d801b8d9d355f8ec33b0e41866841e2870754cf667a9821703d53ae</span><span class="p">,</span>
            <span class="s2">&quot;seq_no&quot;</span><span class="p">:</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="c1"># raw is ffffffff</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="s2">&quot;out_count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="c1"># raw is 01</span>
    <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mi">9960000</span><span class="p">,</span> <span class="c1"># raw is 40fa970000000000</span>
            <span class="s2">&quot;script_size&quot;</span><span class="p">:</span> <span class="mh">0x17</span><span class="p">,</span> <span class="c1"># raw is 17</span>
            <span class="s2">&quot;script&quot;</span><span class="p">:</span> <span class="mh">0xa9146ebdbaf0840274a6b23b0643b75ef4e8e24f37b887</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">],</span>
<span class="p">}</span>

<span class="n">input_script</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;OP_0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;0x48&quot;</span><span class="p">,</span> <span class="c1"># 72 bytes</span>
    <span class="mh">0x3044022018b88c05ab571cf31bf317a98ed5909cf43218f472bfbeb82b6857d3b1edf4ee0220686627e66b368e298114a097b5814a76fdaac23f7728a42d38415552ba68c8220101</span><span class="p">,</span>
    <span class="s2">&quot;0x49&quot;</span><span class="p">,</span> <span class="c1"># 73 bytes</span>
    <span class="mh">0x3046022100b7a70f4c3b2b5d24475f9664bb77b6046c0251c89b446aad8a86b584b74ed414022100d53dd27b741801a908fdf7c2ee259f444f549b56d7a6c682599ef67b1edb6d2401</span><span class="p">,</span>
    <span class="s2">&quot;OP_PUSHDATA1&quot;</span><span class="p">,</span> <span class="c1"># 0x4c</span>
    <span class="s2">&quot;0xc9&quot;</span><span class="p">,</span> <span class="c1"># 0xc9 bytes as the length</span>
    <span class="mh">0x524104f3d35132084eb1b99b6506178c20adb42d26296012e452e392689bdb6553db33ba24b900000892805de1646821c7b0fb50b3d879c26e2b493b7041e6215356a04104ab4ecc9e8ea2da0562af25bcaede00c4d5a00db60edc17672376decf0a35a34fdc9f1ffad1fb74fd7b1b198b9231c25df88e0769bec49975649b4b3f40adafb04104f7149f270717c00f6cc09b9ce3c22791c4aab1af40a5107aacca85b6f644cc0d84459e308f998d801b8d9d355f8ec33b0e41866841e2870754cf667a9821703d53ae</span>
<span class="p">]</span>

<span class="c1"># 主要看 input_script[7]，也就是 0x5241...</span>
<span class="n">p2sh_redeem_script</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;OP_2&quot;</span><span class="p">,</span> <span class="c1"># 0x52</span>
    <span class="s2">&quot;0x41&quot;</span><span class="p">,</span> <span class="c1"># 65 bytes</span>
    <span class="mh">0x04f3d35132084eb1b99b6506178c20adb42d26296012e452e392689bdb6553db33ba24b900000892805de1646821c7b0fb50b3d879c26e2b493b7041e6215356a0</span><span class="p">,</span> <span class="c1"># 65 bytes</span>
    <span class="s2">&quot;0x41&quot;</span><span class="p">,</span> <span class="c1"># 65 bytes</span>
    <span class="mh">0x04ab4ecc9e8ea2da0562af25bcaede00c4d5a00db60edc17672376decf0a35a34fdc9f1ffad1fb74fd7b1b198b9231c25df88e0769bec49975649b4b3f40adafb0</span><span class="p">,</span> <span class="c1"># 65 bytes</span>
    <span class="s2">&quot;0x41&quot;</span><span class="p">,</span> <span class="c1"># 65 bytes</span>
    <span class="mh">0x04f7149f270717c00f6cc09b9ce3c22791c4aab1af40a5107aacca85b6f644cc0d84459e308f998d801b8d9d355f8ec33b0e41866841e2870754cf667a9821703d</span><span class="p">,</span> <span class="c1"># 65 bytes</span>
    <span class="s2">&quot;OP_3&quot;</span><span class="p">,</span> <span class="c1"># 0x53</span>
    <span class="s2">&quot;OP_CHECKMULTISIG&quot;</span><span class="p">,</span> <span class="c1"># 0xae</span>
<span class="p">]</span>
<span class="n">p2sh_redeem_script_as_bytes</span> <span class="o">=</span> <span class="n">input_script</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mh">0xc9</span><span class="p">,</span> <span class="s2">&quot;big&quot;</span><span class="p">)</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">p2sh_redeem_script_as_bytes</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
<span class="n">tmp_hasher</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;ripemd160&#39;</span><span class="p">)</span>
<span class="n">tmp_hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
<span class="n">computed_p2sh_script_hash</span> <span class="o">=</span> <span class="n">tmp_hasher</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">computed_p2sh_script_hash</span> <span class="o">==</span> <span class="n">p2sh_script_hash</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>从上面可以看出，这个 <code class="docutils literal notranslate"><span class="pre">2/3</span></code> 多签地址的三个公钥以及对应地址分别是</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pub_key_1</span> <span class="o">=</span> <span class="mh">0x04f3d35132084eb1b99b6506178c20adb42d26296012e452e392689bdb6553db33ba24b900000892805de1646821c7b0fb50b3d879c26e2b493b7041e6215356a0</span>
<span class="n">pub_key_2</span> <span class="o">=</span> <span class="mh">0x04ab4ecc9e8ea2da0562af25bcaede00c4d5a00db60edc17672376decf0a35a34fdc9f1ffad1fb74fd7b1b198b9231c25df88e0769bec49975649b4b3f40adafb0</span>
<span class="n">pub_key_3</span> <span class="o">=</span> <span class="mh">0x04f7149f270717c00f6cc09b9ce3c22791c4aab1af40a5107aacca85b6f644cc0d84459e308f998d801b8d9d355f8ec33b0e41866841e2870754cf667a9821703d</span>

<span class="n">compressed_pub_key_1</span> <span class="o">=</span> <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x02</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">pub_key_1</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x03</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">pub_key_1</span><span class="o">&gt;&gt;</span><span class="mi">256</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="o">**</span><span class="mi">256</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
<span class="n">compressed_pub_key_2</span> <span class="o">=</span> <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x02</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">pub_key_2</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x03</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">pub_key_2</span><span class="o">&gt;&gt;</span><span class="mi">256</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="o">**</span><span class="mi">256</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
<span class="n">compressed_pub_key_3</span> <span class="o">=</span> <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x02</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">pub_key_3</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x03</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">pub_key_3</span><span class="o">&gt;&gt;</span><span class="mi">256</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="o">**</span><span class="mi">256</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>

<span class="n">address_1</span> <span class="o">=</span> <span class="n">get_address</span><span class="p">(</span><span class="n">compressed_pub_key_1</span><span class="p">)</span>
<span class="n">address_2</span> <span class="o">=</span> <span class="n">get_address</span><span class="p">(</span><span class="n">compressed_pub_key_2</span><span class="p">)</span>
<span class="n">address_3</span> <span class="o">=</span> <span class="n">get_address</span><span class="p">(</span><span class="n">compressed_pub_key_3</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;address_1: </span><span class="si">{</span><span class="n">address_1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;address_2: </span><span class="si">{</span><span class="n">address_2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;address_3: </span><span class="si">{</span><span class="n">address_3</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>address_1: 1BhbbJKpn83Npz1qL1ngexnXASyNBn5Wsc
address_2: 1EtfNeupjsjq5Dn2eNEEQp2DaFgfPFSBdp
address_3: 1HbPBdgvD8GbYedhZxAtBMxE8TkWVQFfii
</pre></div>
</div>
</div>
</div>
<p>为了把收到的币发走，上面的交易使用了3个私钥中的2个，这个体现在两个签名上。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 先看看bitcoin message签名的例子</span>

<span class="k">def</span> <span class="nf">secp256k1_mul</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">point</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">256</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">point</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">):</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">secp256k1_add</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">secp256k1_add</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span>    

<span class="c1"># 测试bitcoin wallet对消息的签名</span>
<span class="k">def</span> <span class="nf">secp256k1_check_msg_signature</span><span class="p">(</span><span class="n">pub_key</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">sig</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">assert</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">secp256k1_n</span> <span class="ow">and</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">secp256k1_n</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">250</span>
    <span class="n">to_verify_str</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x18</span><span class="s2">Bitcoin Signed Message:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">msg</span>
    <span class="n">to_verify_str_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">to_verify_str</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
    <span class="n">to_verify_str_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">to_verify_str_hash</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>

    <span class="n">z</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">to_verify_str_hash</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">r</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">%</span> <span class="n">secp256k1_p</span>
    <span class="k">assert</span> <span class="n">secp256k1_p</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="n">y</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="p">(</span><span class="n">secp256k1_p</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">4</span><span class="p">,</span> <span class="n">secp256k1_p</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">y</span> <span class="o">*</span> <span class="n">y</span> <span class="o">%</span> <span class="n">secp256k1_p</span> <span class="o">==</span> <span class="n">x2</span>

    <span class="c1"># Compute the header byte. </span>
    <span class="c1"># https://en.bitcoin.it/wiki/Message_signing @FIXME</span>
    <span class="c1"># If r &lt; p-n and is_even(y), set HeaderByte to 30. @FIXME is_odd</span>
    <span class="c1"># If r &lt; p-n and is_odd(y), set HeaderByte to 27.  @FIXME is_even</span>
    <span class="c1"># If r ≥ p-n and is_even(y), set HeaderByte to 28.  @FIXME is_odd?</span>
    <span class="c1"># If r ≥ p-n and is_odd(y), set HeaderByte to 29. @FIXME is_even</span>
    <span class="k">if</span> <span class="n">header</span> <span class="o">==</span> <span class="mh">0x1c</span><span class="p">:</span> <span class="c1"># 28</span>
        <span class="k">assert</span> <span class="n">r</span> <span class="o">&gt;=</span> <span class="n">secp256k1_p</span> <span class="o">-</span> <span class="n">secp256k1_n</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">secp256k1_p</span> <span class="o">-</span> <span class="n">y</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="kc">False</span>

    <span class="n">R</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">secp256k1_n</span><span class="o">*</span><span class="mi">2</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span> <span class="o">%</span> <span class="n">secp256k1_n</span>

    <span class="n">r_inv</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">secp256k1_n</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">r</span> <span class="o">*</span> <span class="n">r_inv</span> <span class="o">%</span> <span class="n">secp256k1_n</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="n">t1</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="n">r_inv</span> <span class="o">%</span> <span class="n">secp256k1_n</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">e</span> <span class="o">*</span> <span class="n">r_inv</span> <span class="o">%</span> <span class="n">secp256k1_n</span>
    <span class="n">PublicKey</span> <span class="o">=</span> <span class="n">secp256k1_add</span><span class="p">(</span><span class="n">secp256k1_mul</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">R</span><span class="p">),</span> <span class="n">secp256k1_mul</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="p">(</span><span class="n">secp256k1_Gx</span><span class="p">,</span> <span class="n">secp256k1_Gy</span><span class="p">)))</span>
    <span class="k">assert</span> <span class="n">PublicKey</span> <span class="o">==</span> <span class="n">pub_key</span>


<span class="c1"># test example (uncompressed public key)</span>
<span class="n">to_test_priv_key</span> <span class="o">=</span> <span class="n">base58</span><span class="o">.</span><span class="n">b58decode</span><span class="p">(</span><span class="s2">&quot;5KYZdUEo39z3FPrtuX2QbbwGnNP5zTd7yyr2SC1j299sBCnWjss&quot;</span><span class="p">)</span>
<span class="n">to_test_priv_key</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">to_test_priv_key</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>

<span class="n">to_test_pub_point</span> <span class="o">=</span> <span class="n">priv_key_to_pub_key</span><span class="p">(</span><span class="n">to_test_priv_key</span><span class="p">)</span>
<span class="n">to_test_pub_key</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x04</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">to_test_pub_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">to_test_pub_point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
<span class="n">to_test_address</span> <span class="o">=</span> <span class="n">get_address</span><span class="p">(</span><span class="n">to_test_pub_key</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">to_test_address</span> <span class="o">==</span> <span class="s2">&quot;1HZwkjkeaoZfTSaJxDw6aKkxp45agDiEzN&quot;</span>

<span class="n">to_test_msg</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;abc&quot;</span>

<span class="kn">import</span> <span class="nn">base64</span>
<span class="n">to_test_sig</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="s2">&quot;HArNwRD6S0Z5xej3kMdPBaIe1p/w3avfFYD6EwZVhc5gUyDp8vu9MhvWP84s2vYQvuXVBRi2ev0Rp9sSYIcVgPA=&quot;</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_test_sig</span><span class="p">)</span> <span class="o">==</span> <span class="mi">65</span>
<span class="n">to_test_sig_header_byte</span> <span class="o">=</span> <span class="n">to_test_sig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">assert</span> <span class="n">to_test_sig_header_byte</span> <span class="o">==</span> <span class="mh">0x1c</span> <span class="c1"># ECDSA verification, P2PKH uncompressed address</span>
<span class="n">to_test_sig</span> <span class="o">=</span> <span class="n">to_test_sig</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="n">to_test_sig</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">to_test_sig</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
<span class="n">to_test_r</span> <span class="o">=</span> <span class="n">to_test_sig</span> <span class="o">&gt;&gt;</span> <span class="mi">256</span>
<span class="n">to_test_s</span> <span class="o">=</span> <span class="n">to_test_sig</span> <span class="o">%</span> <span class="mi">2</span><span class="o">**</span><span class="mi">256</span>

<span class="n">secp256k1_check_msg_signature</span><span class="p">(</span><span class="n">to_test_pub_point</span><span class="p">,</span> <span class="p">(</span><span class="n">to_test_r</span><span class="p">,</span> <span class="n">to_test_s</span><span class="p">),</span> <span class="n">to_test_msg</span><span class="p">,</span> <span class="n">to_test_sig_header_byte</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 再来验证一下交易的签名</span>

<span class="c1"># not bip-0062??? @FIXME</span>
<span class="n">sig_1</span> <span class="o">=</span> <span class="mh">0x3044022018b88c05ab571cf31bf317a98ed5909cf43218f472bfbeb82b6857d3b1edf4ee0220686627e66b368e298114a097b5814a76fdaac23f7728a42d38415552ba68c82201</span> <span class="c1">#@FIXME 01</span>
<span class="n">sig_1_parsed</span> <span class="o">=</span> <span class="mh">0x18b88c05ab571cf31bf317a98ed5909cf43218f472bfbeb82b6857d3b1edf4ee686627e66b368e298114a097b5814a76fdaac23f7728a42d38415552ba68c822</span>
<span class="c1"># yes bip-0062</span>
<span class="n">sig_2</span> <span class="o">=</span> <span class="mh">0x3046022100b7a70f4c3b2b5d24475f9664bb77b6046c0251c89b446aad8a86b584b74ed414022100d53dd27b741801a908fdf7c2ee259f444f549b56d7a6c682599ef67b1edb6d2401</span>
<span class="n">sig_2_parsed</span> <span class="o">=</span> <span class="mh">0xb7a70f4c3b2b5d24475f9664bb77b6046c0251c89b446aad8a86b584b74ed414d53dd27b741801a908fdf7c2ee259f444f549b56d7a6c682599ef67b1edb6d24</span>

<span class="k">def</span> <span class="nf">get_sig_hash</span><span class="p">():</span>
    <span class="n">raw</span> <span class="o">=</span> <span class="s2">&quot;01000000&quot;</span> <span class="c1">#version </span>
    <span class="n">raw</span> <span class="o">+=</span> <span class="s2">&quot;01&quot;</span> <span class="c1">#in count </span>
    <span class="n">raw</span> <span class="o">+=</span> <span class="s2">&quot;13fc91b458c8ed3a826cfc984ab454246036f91a4beafb56b88b115e8db1add3&quot;</span>  <span class="c1"># in tx</span>
    <span class="n">raw</span> <span class="o">+=</span> <span class="s2">&quot;00000000&quot;</span>  <span class="c1"># in index</span>
    <span class="n">raw</span> <span class="o">+=</span> <span class="s2">&quot;fd5f01&quot;</span>  <span class="c1"># in script len</span>
    <span class="n">raw</span> <span class="o">+=</span> <span class="s2">&quot;00483044022018b88c05ab571cf31bf317a98ed5909cf43218f472bfbeb82b68&quot;</span>  <span class="c1"># input_script</span>
    <span class="n">raw</span> <span class="o">+=</span> <span class="s2">&quot;57d3b1edf4ee0220686627e66b368e298114a097b5814a76fdaac23f7728a42d&quot;</span> 
    <span class="n">raw</span> <span class="o">+=</span> <span class="s2">&quot;38415552ba68c8220101493046022100b7a70f4c3b2b5d24475f9664bb77b604&quot;</span> 
    <span class="n">raw</span> <span class="o">+=</span> <span class="s2">&quot;6c0251c89b446aad8a86b584b74ed414022100d53dd27b741801a908fdf7c2ee&quot;</span> 
    <span class="n">raw</span> <span class="o">+=</span> <span class="s2">&quot;259f444f549b56d7a6c682599ef67b1edb6d24014cc9&quot;</span>  <span class="c1"># total  32 + 32 + 32 + 32 + 22 = 150 bytes till now</span>
    <span class="n">raw</span> <span class="o">+=</span> <span class="s2">&quot;524104f3d35132084eb1b99b6506178c20adb42d26296012e452e392689bdb65&quot;</span>  <span class="c1"># starting of the redeem script</span>
    <span class="n">raw</span> <span class="o">+=</span> <span class="s2">&quot;53db33ba24b900000892805de1646821c7b0fb50b3d879c26e2b493b7041e621&quot;</span> 
    <span class="n">raw</span> <span class="o">+=</span> <span class="s2">&quot;5356a04104ab4ecc9e8ea2da0562af25bcaede00c4d5a00db60edc17672376de&quot;</span> 
    <span class="n">raw</span> <span class="o">+=</span> <span class="s2">&quot;cf0a35a34fdc9f1ffad1fb74fd7b1b198b9231c25df88e0769bec49975649b4b&quot;</span> 
    <span class="n">raw</span> <span class="o">+=</span> <span class="s2">&quot;3f40adafb04104f7149f270717c00f6cc09b9ce3c22791c4aab1af40a5107aac&quot;</span> 
    <span class="n">raw</span> <span class="o">+=</span> <span class="s2">&quot;ca85b6f644cc0d84459e308f998d801b8d9d355f8ec33b0e41866841e2870754cf667a9821703d53ae&quot;</span> 
    <span class="c1"># other parts</span>
    <span class="n">raw</span> <span class="o">+=</span> <span class="s2">&quot;ffffffff0140fa97000000000017a9146ebdbaf0840274a6b23b0643b75ef4e8e24f37b88700000000&quot;</span>
    
    <span class="c1"># the 150 bytes above should be removed and then hash it</span>
    <span class="c1"># remember to update the input script length</span>
    <span class="n">modified_raw</span> <span class="o">=</span> <span class="s2">&quot;01000000&quot;</span> <span class="c1">#version</span>
    <span class="n">modified_raw</span> <span class="o">+=</span> <span class="s2">&quot;01&quot;</span>  <span class="c1">#in count</span>
    <span class="n">modified_raw</span> <span class="o">+=</span> <span class="s2">&quot;13fc91b458c8ed3a826cfc984ab454246036f91a4beafb56b88b115e8db1add3&quot;</span>  <span class="c1"># in tx</span>
    <span class="n">modified_raw</span> <span class="o">+=</span> <span class="s2">&quot;00000000&quot;</span>  <span class="c1"># in index</span>
    <span class="n">modified_raw</span> <span class="o">+=</span> <span class="s2">&quot;c9&quot;</span>  <span class="c1"># in script len (updated here)</span>
    <span class="n">modified_raw</span> <span class="o">+=</span> <span class="s2">&quot;524104f3d35132084eb1b99b6506178c20adb42d26296012e452e392689bdb65&quot;</span>  <span class="c1"># starting of the redeem script</span>
    <span class="n">modified_raw</span> <span class="o">+=</span> <span class="s2">&quot;53db33ba24b900000892805de1646821c7b0fb50b3d879c26e2b493b7041e621&quot;</span> 
    <span class="n">modified_raw</span> <span class="o">+=</span> <span class="s2">&quot;5356a04104ab4ecc9e8ea2da0562af25bcaede00c4d5a00db60edc17672376de&quot;</span> 
    <span class="n">modified_raw</span> <span class="o">+=</span> <span class="s2">&quot;cf0a35a34fdc9f1ffad1fb74fd7b1b198b9231c25df88e0769bec49975649b4b&quot;</span> 
    <span class="n">modified_raw</span> <span class="o">+=</span> <span class="s2">&quot;3f40adafb04104f7149f270717c00f6cc09b9ce3c22791c4aab1af40a5107aac&quot;</span> 
    <span class="n">modified_raw</span> <span class="o">+=</span> <span class="s2">&quot;ca85b6f644cc0d84459e308f998d801b8d9d355f8ec33b0e41866841e2870754cf667a9821703d53ae&quot;</span> 
    <span class="c1"># other parts</span>
    <span class="n">modified_raw</span> <span class="o">+=</span> <span class="s2">&quot;ffffffff0140fa97000000000017a9146ebdbaf0840274a6b23b0643b75ef4e8e24f37b88700000000&quot;</span>

    <span class="n">hashType</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">modified_raw</span> <span class="o">+=</span> <span class="n">hashType</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>

    <span class="c1">#print(modified_raw)</span>

    <span class="nb">hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">modified_raw</span><span class="p">))</span><span class="o">.</span><span class="n">digest</span><span class="p">())</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="nb">hash</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">check_sig</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">neg</span><span class="p">):</span>
    <span class="c1"># 这个hash怎么来的呢？</span>
    <span class="c1"># 这个是把raw send tx中的 input[0] script去掉，取而代之 input[0] script中的 p2sh_redeem_script 而得到一个新的tx</span>
    <span class="c1"># 然后hash得到的</span>
    <span class="nb">hash</span> <span class="o">=</span> <span class="mh">0x981ace47e8d869bf17fd93558d536013841bebd38ed59270ad715174e8ab3e2d</span>
    <span class="k">assert</span> <span class="nb">hash</span> <span class="o">==</span> <span class="n">get_sig_hash</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">rs</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="mi">256</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">rs</span> <span class="o">&gt;&gt;</span> <span class="mi">256</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">rs</span> <span class="o">%</span> <span class="mi">2</span><span class="o">**</span><span class="mi">256</span>

    <span class="k">assert</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">secp256k1_n</span>
    <span class="k">assert</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">secp256k1_n</span>

    <span class="n">z</span> <span class="o">=</span> <span class="nb">hash</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">r</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">%</span> <span class="n">secp256k1_p</span>
    <span class="k">assert</span> <span class="n">secp256k1_p</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="n">y</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="p">(</span><span class="n">secp256k1_p</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">4</span><span class="p">,</span> <span class="n">secp256k1_p</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">y</span> <span class="o">*</span> <span class="n">y</span> <span class="o">%</span> <span class="n">secp256k1_p</span> <span class="o">==</span> <span class="n">x2</span>

    <span class="k">if</span> <span class="n">neg</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">secp256k1_p</span> <span class="o">-</span> <span class="n">y</span> <span class="c1"># FIXME</span>

    <span class="n">R</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">secp256k1_n</span><span class="o">*</span><span class="mi">2</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span> <span class="o">%</span> <span class="n">secp256k1_n</span>

    <span class="n">r_inv</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">secp256k1_n</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">r</span> <span class="o">*</span> <span class="n">r_inv</span> <span class="o">%</span> <span class="n">secp256k1_n</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="n">t1</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="n">r_inv</span> <span class="o">%</span> <span class="n">secp256k1_n</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">e</span> <span class="o">*</span> <span class="n">r_inv</span> <span class="o">%</span> <span class="n">secp256k1_n</span>
    <span class="n">public_point</span> <span class="o">=</span> <span class="n">secp256k1_add</span><span class="p">(</span><span class="n">secp256k1_mul</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">R</span><span class="p">),</span> <span class="n">secp256k1_mul</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="p">(</span><span class="n">secp256k1_Gx</span><span class="p">,</span> <span class="n">secp256k1_Gy</span><span class="p">)))</span>
    <span class="n">public_key</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x04</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">public_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">public_point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
    <span class="n">public_key</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">public_key</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">public_key</span> <span class="o">==</span> <span class="n">pub_key_3</span> <span class="ow">or</span> <span class="n">public_key</span> <span class="o">==</span> <span class="n">pub_key_2</span> <span class="ow">or</span> <span class="n">public_key</span> <span class="o">==</span> <span class="n">pub_key_1</span>

<span class="n">check_sig</span><span class="p">(</span><span class="n">sig_1_parsed</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">check_sig</span><span class="p">(</span><span class="n">sig_2_parsed</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="electrum">
<h2>Electrum钱包<a class="headerlink" href="#electrum" title="Permalink to this heading">#</a></h2>
<p>为了方便的支持多签地址，我们来尝试用一个ledger设备产生一个 <code class="docutils literal notranslate"><span class="pre">2/2</span></code> 多签地址。</p>
<p>为此，我们选择之前测试过的ledger助记词。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ledger_mnemonic_words</span> <span class="o">=</span> <span class="s2">&quot;fabric gaze exchange canvas symbol use swamp arctic resemble label guide angry nature solve laptop exit fuel result hood cactus piece hotel divorce illegal&quot;</span>
<span class="n">ledger_first_btc_address_info_from_computed</span> <span class="o">=</span> <span class="n">mnemonic_to_key</span><span class="p">(</span><span class="n">ledger_mnemonic_words</span><span class="p">,</span> <span class="p">[</span><span class="mi">44</span><span class="o">+</span><span class="mi">2</span><span class="o">**</span><span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="o">+</span><span class="mi">2</span><span class="o">**</span><span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="o">+</span><span class="mi">2</span><span class="o">**</span><span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">ledger_first_btc_address_shown</span> <span class="o">=</span> <span class="s2">&quot;16MoycEPk6ZUGnrR5EkmNJgkap1hnLKcVr&quot;</span>
<span class="k">assert</span> <span class="n">ledger_first_btc_address_info_from_computed</span><span class="p">[</span><span class="s2">&quot;address&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ledger_first_btc_address_shown</span>

<span class="n">ledger_extra_password</span> <span class="o">=</span> <span class="s2">&quot;12345&quot;</span>
<span class="n">ledger_extra_btc_address_info_from_computed</span> <span class="o">=</span> <span class="n">mnemonic_to_key</span><span class="p">(</span><span class="n">ledger_mnemonic_words</span><span class="p">,</span> <span class="p">[</span><span class="mi">44</span><span class="o">+</span><span class="mi">2</span><span class="o">**</span><span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="o">+</span><span class="mi">2</span><span class="o">**</span><span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="o">+</span><span class="mi">2</span><span class="o">**</span><span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">extra_phrase</span><span class="o">=</span><span class="n">ledger_extra_password</span><span class="p">)</span>
<span class="n">ledger_extra_btc_address_shown</span> <span class="o">=</span> <span class="s2">&quot;1PB24uzHD786A5x6xSKjLtBBewnvapC2rk&quot;</span>
<span class="k">assert</span> <span class="n">ledger_extra_btc_address_info_from_computed</span><span class="p">[</span><span class="s2">&quot;address&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ledger_extra_btc_address_shown</span>
</pre></div>
</div>
</div>
</div>
<p>生成多签地址如下</p>
<p>注意要使用路径 <code class="docutils literal notranslate"><span class="pre">m/44h/0h/0h</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scripts</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>

<span class="n">scripts</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x52</span><span class="s1">&#39;</span> <span class="c1"># OP_2</span>

<span class="n">ledger_first_btc_address_pubkey</span> <span class="o">=</span> <span class="n">priv_key_to_pub_key</span><span class="p">(</span><span class="n">ledger_first_btc_address_info_from_computed</span><span class="p">[</span><span class="s2">&quot;private_key&quot;</span><span class="p">])</span>
<span class="n">ledger_first_btc_address_pubkey_in_full</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x04</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">ledger_first_btc_address_pubkey</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">ledger_first_btc_address_pubkey</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ledger_first_btc_address_pubkey_in_full</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x41</span>
<span class="n">ledger_first_btc_address_pubkey_in_compressed</span> <span class="o">=</span> <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x02</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">ledger_first_btc_address_pubkey</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x03</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">ledger_first_btc_address_pubkey</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
<span class="c1">#print(f&quot;ledger_first_btc_address_pubkey_in_compressed: {ledger_first_btc_address_pubkey_in_compressed.hex()}&quot;)</span>

<span class="n">ledger_extra_btc_address_pubkey</span> <span class="o">=</span> <span class="n">priv_key_to_pub_key</span><span class="p">(</span><span class="n">ledger_extra_btc_address_info_from_computed</span><span class="p">[</span><span class="s2">&quot;private_key&quot;</span><span class="p">])</span>
<span class="n">ledger_extra_btc_address_pubkey_in_full</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x04</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">ledger_extra_btc_address_pubkey</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">ledger_extra_btc_address_pubkey</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ledger_extra_btc_address_pubkey_in_full</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x41</span>
<span class="n">ledger_extra_btc_address_pubkey_in_compressed</span> <span class="o">=</span> <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x02</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">ledger_extra_btc_address_pubkey</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x03</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">ledger_extra_btc_address_pubkey</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
<span class="c1">#print(f&quot;ledger_extra_btc_address_pubkey_in_compressed: {ledger_extra_btc_address_pubkey_in_compressed.hex()}&quot;)</span>

<span class="c1">#scripts += b&#39;\x41&#39; + ledger_first_btc_address_pubkey_in_full</span>
<span class="c1">#scripts += b&#39;\x41&#39; + ledger_extra_btc_address_pubkey_in_full</span>

<span class="c1"># NOTE HERE, compressed pubkey is used and sorted in ascending order</span>
<span class="n">scripts</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ledger_extra_btc_address_pubkey_in_compressed</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">ledger_extra_btc_address_pubkey_in_compressed</span>
<span class="n">scripts</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ledger_first_btc_address_pubkey_in_compressed</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">ledger_first_btc_address_pubkey_in_compressed</span>

<span class="n">scripts</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x52</span><span class="s1">&#39;</span> <span class="c1"># OP_2 # 2 of 2 multisig</span>

<span class="n">scripts</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xae</span><span class="s1">&#39;</span> <span class="c1"># OP_CHECKMULTISIG</span>

<span class="c1">#print(f&quot;scripts: {scripts.hex()}&quot;)</span>

<span class="n">tmp</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">scripts</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
<span class="n">tmp_hasher</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;ripemd160&#39;</span><span class="p">)</span>
<span class="n">tmp_hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
<span class="n">computed_p2sh_script_hash</span> <span class="o">=</span> <span class="n">tmp_hasher</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>

<span class="n">ledger_multisig_address</span> <span class="o">=</span> <span class="n">p2sh_script_hash_to_address</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">computed_p2sh_script_hash</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ledger_multisig_address: </span><span class="si">{</span><span class="n">ledger_multisig_address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">ledger_multisig_address</span> <span class="o">==</span> <span class="s2">&quot;3BnE4RWzb4UZXQcvVapvuu4WpzzhZJy9y8&quot;</span>

<span class="n">xpubkey_1</span> <span class="o">=</span> <span class="s2">&quot;xpub6GdugpUt76LRoHnJfg1h7fCKBqbwE3xuco6VEnBoG3MUAz4RNzCBsK4Mykz6LQCdftMqghizzqeWna7rvMUpYjWQcECtzYx93MuNdLr9vrj&quot;</span>
<span class="n">xpubkey_1</span> <span class="o">=</span> <span class="n">base58</span><span class="o">.</span><span class="n">b58decode</span><span class="p">(</span><span class="n">xpubkey_1</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
<span class="n">xpubkey_1</span> <span class="o">=</span> <span class="n">xpubkey_1</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="c1"># remove checksum</span>
<span class="n">xpubkey_1</span> <span class="o">=</span> <span class="n">xpubkey_1</span><span class="p">[</span><span class="o">-</span><span class="mi">33</span><span class="p">:]</span>
<span class="k">assert</span> <span class="n">xpubkey_1</span> <span class="o">==</span> <span class="n">ledger_first_btc_address_pubkey_in_compressed</span>

<span class="n">xpubkey_2</span> <span class="o">=</span> <span class="s2">&quot;xpub6G8Pr2mm2eZfQzsHQfuwdv2UYbQCLjAbA5oZQwoxGRqLxEGtmRoswCVJBx25KYcBMogaaGzTThkMuAGzcjf5Lc52D4cDh37weRXnWKYwaGa&quot;</span>
<span class="n">xpubkey_2</span> <span class="o">=</span> <span class="n">base58</span><span class="o">.</span><span class="n">b58decode</span><span class="p">(</span><span class="n">xpubkey_2</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
<span class="n">xpubkey_2</span> <span class="o">=</span> <span class="n">xpubkey_2</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="c1"># remove checksum</span>
<span class="n">xpubkey_2</span> <span class="o">=</span> <span class="n">xpubkey_2</span><span class="p">[</span><span class="o">-</span><span class="mi">33</span><span class="p">:]</span>
<span class="k">assert</span> <span class="n">xpubkey_2</span> <span class="o">==</span> <span class="n">ledger_extra_btc_address_pubkey_in_compressed</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ledger_multisig_address: 3BnE4RWzb4UZXQcvVapvuu4WpzzhZJy9y8
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="intro.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Welcome to your Jupyter Book</p>
      </div>
    </a>
    <a class="right-next"
       href="how-to-use-electrum.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">How to use electrum?</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bip0039">BIP0039 生成确定性密钥的助记词</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bip0032">BIP0032 分层确定性钱包</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bither-net">bither.net钱包</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bitherhd">bither非HD模式</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ledger-nano-s-plus">Ledger Nano S Plus</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#btc">手搓BTC</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#multi-sigbtc">multi-sig多签存储btc</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#electrum">Electrum钱包</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By ssli
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>